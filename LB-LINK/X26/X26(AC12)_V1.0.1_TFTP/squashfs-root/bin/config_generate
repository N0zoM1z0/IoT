#!/bin/sh

CFG=/etc/board.json

. /usr/share/libubox/jshn.sh

[ -f $CFG ] || exit 1

generate_static_network() {
	uci -q batch <<EOF
delete network.loopback
set network.loopback='interface'
set network.loopback.ifname='lo'
set network.loopback.proto='static'
set network.loopback.ipaddr='127.0.0.1'
set network.loopback.netmask='255.0.0.0'
delete network.globals
set network.globals='globals'
set network.globals.ula_prefix='auto'
EOF
}

next_vlan=3
generate_network() {
	local vlan

	json_select network
	json_select $1
	json_get_vars ifname create_vlan macaddr
	json_select ..
	json_select ..

	[ -n "$ifname" ] || return
	[ "$create_vlan" -eq 1 ] && case $1 in
	lan) vlan=1;;
	wan) vlan=2;;
	*)
		vlan=$next_vlan
		next_vlan=$((next_vlan + 1))
		;;
	esac
	[ -n "$vlan" ] && ifname=${ifname}.${vlan}
	uci -q batch <<EOF
delete network.$1
set network.$1='interface'
set network.$1.ifname='$ifname'
set network.$1.force_link=1
set network.$1.proto='none'
set network.$1.macaddr='$macaddr'
EOF

	case $1 in
	lan) uci -q batch <<EOF
set network.$1.type='bridge'
set network.$1.proto='static'
set network.$1.ipaddr='192.168.16.1'
set network.$1.netmask='255.255.255.0'
set network.$1.ip6assign='60'
set network.$1.br_traverse_ipv6='0'
EOF
		;;
	wan) uci -q batch <<EOF
set network.$1.proto='dhcp'
delete network.wan6
set network.wan6='interface'
set network.wan6.ifname='$ifname'
set network.wan6.proto='dhcpv6'
EOF
		;;
	esac
}

generate_switch_vlan() {
	local device=$1
	local vlan=$2
	local cpu_port=$3

	case $vlan in
	lan)	vlan=1;;
	wan)	vlan=2;;
	*)	vlan=${vlan##vlan};;
	esac

	json_select vlans
	json_select $2
	json_get_values ports
	json_select ..
	json_select ..

	uci -q batch <<EOF
add network switch_vlan
set network.@switch_vlan[-1].device='$device'
set network.@switch_vlan[-1].vlan='$vlan'
set network.@switch_vlan[-1].ports='$ports ${cpu_port}t'
EOF
}

generate_switch() {
	local key=$1
	local vlans

	json_select switch
	json_select $key
	json_get_vars enable reset blinkrate cpu_port

	uci -q batch <<EOF
add network switch
set network.@switch[-1].name='$key'
set network.@switch[-1].reset='$reset'
set network.@switch[-1].enable_vlan='$enable'
set network.@switch[-1].blinkrate='$blinkrate'
EOF
	[ -n "$cpu_port" ] && {
		json_get_keys vlans vlans
		for vlan in $vlans; do generate_switch_vlan $1 $vlan $cpu_port; done
	}
	json_select ..
	json_select ..
}


generate_static_system() {
	uci -q batch <<EOF	
delete system.route
set system.route='blink'
set system.route.routeusr='admin'
set system.route.routepwd='admin'
set system.route.operationmode='router'
set system.route.conntype='dhcp'
set system.route.sys_default='1'
set system.route.iptv='0'
set system.route.switch_2g='1'
set system.route.switch_2g_guest='0'
set system.route.switch_5g='1'
set system.route.switch_5g_guest='0'
set system.route.ssid_2g='BLINK-xxxx'
set system.route.ssid_2g_guest='BLINK-xxxx-Guest'
set system.route.ssid_5g='BLINK-xxxx-5G'
set system.route.ssid_5g_guest='BLINK-xxxx-5G-Guest'
set system.route.hidden_2g='0'
set system.route.hidden_2g_guest='0'
set system.route.hidden_5g='0'
set system.route.hidden_5g_guest='0'
set system.route.webLoginFirst='0'
set system.route.mtkhnat='1'
set system.route.dhcp_dns='0'
set system.route.wifi_schedule='0'
set system.route.parental_switch='0'
set system.route.lan_ipaddr='192.168.16.1'
set system.route.lan_netmask='255.255.255.0'
set system.route.dhcp_startip='192.168.16.100'
set system.route.dhcp_endip='192.168.16.249'
set system.route.qos_mark='1'
set system.route.wifi_schedule_set_wifi_disable='0'
set system.route.vsftpd='0'
set system.route.samba='0'
set system.route.led_2g_blink='0'
set system.route.advanced_dns_switch='0'
set system.route.remote_manage_switch='0'
set system.route.remote_manage_port='8080'
set system.route.periodic_restart_switch='0'
set system.route.7628_wifi_start='0'
set system.route.7663_wifi_scan='0'

EOF
}



generate_led() {
	local key=$1
	local cfg="led_$key"

	json_select led
	json_select $key
	json_get_vars name sysfs type trigger device interface default
	json_select ..
	json_select ..

	uci -q batch <<EOF
delete system.$cfg
set system.$cfg='led'
set system.$cfg.name='$name'
set system.$cfg.sysfs='$sysfs'
set system.$cfg.dev='$device'
set system.$cfg.trigger='$trigger'
set system.$cfg.port_mask='$port_mask'
set system.$cfg.default='$default'
EOF
	case $type in
	netdev)
		uci -q batch <<EOF
set system.$cfg.trigger='netdev'
set system.$cfg.mode='link tx rx'
EOF
	;;

	usb)
		uci -q batch <<EOF
set system.$cfg.trigger='usbdev'
set system.$cfg.interval='50'
EOF
	;;

	esac
}

json_init
json_load "$(cat ${CFG})"

generate_static_network

json_get_keys keys network
for key in $keys; do generate_network $key; done

json_get_keys keys switch
for key in $keys; do generate_switch $key; done

generate_static_system
json_get_keys keys led
for key in $keys; do generate_led $key; done

uci commit
