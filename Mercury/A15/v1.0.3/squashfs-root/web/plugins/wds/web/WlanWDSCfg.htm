

<div class="head wdsStep">
	<div class="title">
		<h1>{%menuStr.wifiWDS%}</h1>
		<div id="switchCon" class="switchCon switchConHs">
			<i class="switchBg"></i>
			<i class="switchBall"></i>
		</div>
	</div>
	<p class="description"></p>
	<ul class="stepTab">
		<li class="underline"></li>
		<li class="step"><i class="stepNum">1</i><span>{%label.wdsOrgNetGuide%}</span></li>
		<li class="step"><i class="stepNum">2</i><span>{%label.wdsSelectRootDut%}</span></li>
		<li class="step"><i class="stepNum">3</i><span>{%label.wdsSettingLocalDut%}</span></li>
	</ul>
</div>
<div id="WDSCon"></div>
<div class="tipText contentTips"></div><script type="text/javascript">var firstPage="WlanWDSCfgFirst.htm",secondPage="WlanWDSCfgSecond.htm",thirdPage="WlanWDSCfgThird.htm",wirelessResultPage="WlanWDSCfgWirelessResult.htm",endPage="WlanWDSCfgEnd.htm",getDhcpsHd=null,getDhcpcHd=null,getWdsStatusHd=null,MANUAL_WDS=!1,bWirelessLinked=!1,isLanIpChanged=!1,bInWizard=!0,backFromEndPage=!1,BAND_2G=0,BAND_5G=1,BAND_5G1=2,BAND_5G2=3,BAND_STEER=4,gOldLanIP="",gLanIP="",gLanMask="",gLanIPMode="",connectingCount=1,dhcpcRetryCounts=1,dhcpsRetryCounts=1,curWdsBand=BAND_2G,curEqtBand=
BAND_2G,gLocalAPInfo=[];gLocalAPInfo[BAND_2G]={ssid:"",encryption:"",key:"",enable:""};gLocalAPInfo[BAND_5G]={ssid:"",encryption:"",key:"",enable:""};gLocalAPInfo[BAND_5G1]={ssid:"",encryption:"",key:"",enable:""};gLocalAPInfo[BAND_5G2]={ssid:"",encryption:"",key:"",enable:""};gLocalAPInfo[BAND_STEER]={ssid:"",encryption:"",key:"",wifi_enable:"",bs_enable:""};var gRootAPInfo=[];gRootAPInfo[BAND_2G]={ssid:"",encryption:"",key:"",enable:""};gRootAPInfo[BAND_5G]={ssid:"",encryption:"",key:"",enable:""};
gRootAPInfo[BAND_5G1]={ssid:"",encryption:"",key:"",enable:""};gRootAPInfo[BAND_5G2]={ssid:"",encryption:"",key:"",enable:""};var gWDSModel=[];
gWDSModel[BAND_2G]={start_dhcps_detect:{wireless:{start_dhcps_detect_2g:null}},wds_start:function(a){return{wireless:{wds_start_2g:a}}},wlan_wds_dhcps:{wireless:{name:"wlan_wds_2g_dhcps"}},wlan_wds_dhcpc:{wireless:{name:"wlan_wds_2g_dhcpc"}},wlan_wds_status:{wireless:{name:"wlan_wds_2g_status"}},set_wds:function(a){return{wireless:{wlan_wds_2g:a}}},scan_start:{wireless:{scan_start_2g:null}},wlan_scan_status:"wlan_scan_2g_status",wlan_scan:"wlan_scan_2g"};
gWDSModel[BAND_5G]={start_dhcps_detect:{wireless:{start_dhcps_detect_5g:null}},wds_start:function(a){return{wireless:{wds_start_5g:a}}},wlan_wds_dhcps:{wireless:{name:"wlan_wds_5g_dhcps"}},wlan_wds_dhcpc:{wireless:{name:"wlan_wds_5g_dhcpc"}},wlan_wds_status:{wireless:{name:"wlan_wds_5g_status"}},set_wds:function(a){return{wireless:{wlan_wds_5g:a}}},scan_start:{wireless:{scan_start_5g:null}},wlan_scan_status:"wlan_scan_5g_status",wlan_scan:"wlan_scan_5g"};
gWDSModel[BAND_5G1]={start_dhcps_detect:{wireless:{start_dhcps_detect_2g:null}},wds_start:function(a){return{wireless:{wds_start_5g_1:a}}},wlan_wds_dhcps:{wireless:{name:"wlan_wds_2g_dhcps"}},wlan_wds_dhcpc:{wireless:{name:"wlan_wds_2g_dhcpc"}},wlan_wds_status:{wireless:{name:"wlan_wds_5g_1_status"}},set_wds:function(a){return{wireless:{wlan_wds_5g_1:a}}},scan_start:{wireless:{scan_start_5g_1:null}},wlan_scan_status:"wlan_scan_5g_1_status",wlan_scan:"wlan_scan_5g_1"};
gWDSModel[BAND_5G2]={start_dhcps_detect:{wireless:{start_dhcps_detect_2g:null}},wds_start:function(a){return{wireless:{wds_start_5g_4:a}}},wlan_wds_dhcps:{wireless:{name:"wlan_wds_2g_dhcps"}},wlan_wds_dhcpc:{wireless:{name:"wlan_wds_2g_dhcpc"}},wlan_wds_status:{wireless:{name:"wlan_wds_5g_4_status"}},set_wds:function(a){return{wireless:{wlan_wds_5g_4:a}}},scan_start:{wireless:{scan_start_5g_4:null}},wlan_scan_status:"wlan_scan_5g_4_status",wlan_scan:"wlan_scan_5g_4"};var gKeyNames=[];
gKeyNames.wlan_host=[];gKeyNames.wlan_wds=[];gKeyNames.wds_cfg_status=[];gKeyNames.wlan_host[BAND_2G]="wlan_host_2g";gKeyNames.wlan_wds[BAND_2G]="wlan_wds_2g";gKeyNames.wds_cfg_status[BAND_2G]="wds_cfg_status_2g";
slp.bandsProvided==slp.DOUBLE?(gKeyNames.wlan_host[BAND_5G]="wlan_host_5g",gKeyNames.wlan_wds[BAND_5G]="wlan_wds_5g",gKeyNames.wds_cfg_status[BAND_5G]="wds_cfg_status_5g"):slp.bandsProvided==slp.TRIPLE&&(gKeyNames.wlan_host[BAND_5G1]="wlan_host_5g_1",gKeyNames.wlan_host[BAND_5G2]="wlan_host_5g_4",gKeyNames.wlan_wds[BAND_5G1]="wlan_wds_5g_1",gKeyNames.wlan_wds[BAND_5G2]="wlan_wds_5g_4",gKeyNames.wds_cfg_status[BAND_5G1]="wds_cfg_status_5g_1",gKeyNames.wds_cfg_status[BAND_5G2]="wds_cfg_status_5g_4");
function errHandle(a){var b="";switch(a){case ENONE:return!0;case ESYSBUSY:b=errStr.invRequestFailTrylater;break;default:b=errStr.invRequestFail}alarmDialog.show(b);return!1}
function wdsSetLanIp(){$.modify({network:{lan:{ipaddr:gLanIP,netmask:gLanMask,ip_mode:"dynamic"}}},function(a){$.action({network:{apply_lan_config:null}},function(a){loadingDialog.hide(function(){loadingDialog.show({title:label.bridgingRootAP,content:{primary:label.linkSuccStr1+gLanIP+label.linkSuccStr2}});$.changeDomain(gLanIP);$.setTimeout(function(){window.location.href="http://"+gLanIP},12E4);$.setTimeout(function(){lanDetecting(function(){window.location.href="http://"+gLanIP})},4E3)})})})}
function wdsCanceldHandle(){var a=gWDSModel[curWdsBand].set_wds({enable:"0"}),b=gWDSModel[curWdsBand].wds_start({set_ip_immediate:"1"});clearTimeout(getWdsStatusHd);clearTimeout(getDhcpsHd);clearTimeout(getDhcpcHd);gRootAPInfo[curWdsBand].enable="0";$.modify(a,function(){$.action(b)})}
function wdsStatusHd(){if(20<connectingCount)"undefined"!=typeof wdsTimeoutHandle?wdsTimeoutHandle():loadingDialog.hide(function(){confirmDialog.show({content:label.linkFailed,callback:function(a){!0==a?(loadingDialog.show({title:label.bridgingRootAP,content:{primary:label.bridgingAndWait}},null,null,!0,function(){wdsCanceldHandle();stepPage(endPage)}),connectingCount=1,getWdsStatusHd=$.setTimeout(wdsStatusHd,100)):(wdsCanceldHandle(),stepPage(endPage))}})});else{var a=gWDSModel[curWdsBand].wlan_wds_status;
$.query(a,function(b){switch(parseInt(b.wireless[a.wireless.name].status)){case 2:dhcpsRetryCounts=1;getDhcpsHd=$.setTimeout(wdsGetIpDhcpsStatus,100);break;default:connectingCount++,getWdsStatusHd=$.setTimeout(wdsStatusHd,2E3)}},void 0,!0)}}
function dhcpFailHandle(){loadingDialog.hide(function(){confirmDialog.show({title:label.bridgingRootAP,content:label.DHCPOpen,button:{cancelStr:btn.back,confirmStr:btn.retry},callback:function(a){a?(a=gWDSModel[curWdsBand].start_dhcps_detect,connectingCount=dhcpsRetryCounts=dhcpcRetryCounts=1,$.action(a,function(a){loadingDialog.show({title:label.bridgingRootAP,content:{primary:label.bridgingAndWait}},null,null,!0,function(){!1==MANUAL_WDS&&void 0!=wdsTargetIndex&&(wdsTargetIndex=void 0);wdsCanceldHandle()});
getDhcpsHd=$.setTimeout(wdsStatusHd,5E3)},!0)):wdsCanceldHandle()}})})}
function wdsGetIpDhcpsStatus(){var a=gWDSModel[curWdsBand].wlan_wds_dhcps;15<dhcpsRetryCounts?dhcpFailHandle():$.query(a,function(b){if(ENONE==b[ERR_CODE]){var c=parseInt(b.wireless[a.wireless.name].status);b=parseInt(b.wireless[a.wireless.name].result);switch(c){case 0:dhcpsRetryCounts++;getDhcpsHd=$.setTimeout(wdsGetIpDhcpsStatus,1E3);break;case 1:1==b?(dhcpcRetryCounts=1,getDhcpcHd=$.setTimeout(wdsDhcpcGetStatus,100)):dhcpFailHandle();break;default:dhcpFailHandle()}}else dhcpFailHandle()},void 0,
!0)}function wdsDhcpcGetStatus(){if(15<dhcpcRetryCounts)dhcpFailHandle();else{var a=gWDSModel[curWdsBand].wlan_wds_dhcpc;$.query(a,function(b){var c=b.wireless[a.wireless.name];switch(c.status){case "0":dhcpcRetryCounts++;getDhcpcHd=$.setTimeout(wdsDhcpcGetStatus,1E3);break;case "1":dhcpFailHandle();break;case "2":bInWizard?loadingDialog.hide(function(){gLanIP=c.ip;gLanMask=c.mask;stepPage(thirdPage)}):(gOldLanIP=gLanIP=c.ip,gLanMask=c.mask,wdsSetLanIp())}},void 0,!0)}}
function lanIpModeHandle(a){"manual"==gLanIPMode?confirmDialog.show({title:menuStr.wifiWDS,content:label.lanIPMode,callback:function(b){!0==b&&(gLanIPMode="dynamic",$.modify({network:{lan:{ip_mode:"dynamic"}}},null,!0),a())}}):a()}
function stepPage(a){var b,c;a==endPage?$("div.head").removeClass("wdsStep"):($("div.head").addClass("wdsStep"),c=a==firstPage?0:a==secondPage?1:2,b=function(){$($("li.step")[c]).addClass("active").siblings().removeClass("active");$("ul.stepTab").find("li.underline").css({left:$("li.step")[c].offsetLeft+"px",width:$("li.step")[c].offsetWidth+"px"})});loadPage(a,"WDSCon",b)}
function initStaticTextObj(a,b){return $('<ul class="inputCMPT medium wdsTextState"><label class="outerLbl">'+a+'</label><li class="input static"><span>'+b+"</span></li></ul>")[0]}function disableWdsSet(){$(".head").removeClass("wdsStep");$(".description").hide();$(".stepTab").hide();$("#WDSCon").hide();addTitleError("bridgeWarning",label.bridgeWDSWarning,{hasIcon:!1})}
function checkBridgeStatus(){var a={},b=!1;a[uciCustomNetwork.fileName]={};a[uciCustomNetwork.fileName][KEY_NAME]=[uciCustomNetwork.dynData.bridgeStatus];$.query(a,function(a){a[ERR_CODE]==ENONE&&((b=1==a.custom_network.bridge_status.enable)?disableWdsSet():init())})}
function init(){var a=!1,b={wireless:{name:[]},network:{name:["lan"]},hosts_info:{table:["host_info"]}},c;for(c in gKeyNames)gKeyNames.hasOwnProperty(c)&&$.each(gKeyNames[c],function(a,c){null!=c&&b.wireless.name.push(c)});slp.bandSteeringProvided&&b.wireless.name.push("wlan_bs");slp.moduleSpec.wifi_switch&&1==slp.moduleSpec.wifi_switch&&(a=!0,b.wireless.name.push("wifi_switch"));$.query(b,function(b){if(a){if(b[uciWireless.fileName][uciWireless.dynData.wifi_switch][uciWireless.dynOptName.enable]!=
uciWireless.dynOptValue.enable.on){$("#WDSCon").css("display","none");$("div.tipText").html(label.wifiAllSwitchCloseStateTipsForWDS);$("div.tipText").css("display","block");$("div.head").removeClass("wdsStep");void 0==id("wifiAllSwitchClose")&&addTitleError("wifiAllSwitchClose",label.canNotSetWdsDueToWifiAllSwitch,{hasIcon:!1,hasBtn:!0,btnArr:[{btnStr:btn.openWifiAllSwitch,btnOnclick:function(){var a={};a[uciWireless.dynData.wifi_switch]={};a[uciWireless.dynData.wifi_switch][uciWireless.dynOptName.enable]=
uciWireless.dynOptValue.enable.on;slp.host.setData({data:a,success:function(){init()}})}}]});return}$("#WDSCon").css("display","block");$("div.tipText").css("display","none");$("div.head").addClass("wdsStep");void 0!=id("wifiAllSwitchClose")&&removeTitleError("wifiAllSwitchClose")}$.each(gKeyNames.wlan_host,function(a,c){null!=c&&(gLocalAPInfo[a].enable=b.wireless[c].enable,gLocalAPInfo[a].ssid=b.wireless[c].ssid,gLocalAPInfo[a].encryption=b.wireless[c].encryption,gLocalAPInfo[a].key=b.wireless[c].key)});
$.each(gKeyNames.wlan_wds,function(a,c){null!=c&&(gRootAPInfo[a].enable=b.wireless[c].enable,gRootAPInfo[a].ssid=b.wireless[c].ssid,gRootAPInfo[a].encryption=b.wireless[c].encryption,gRootAPInfo[a].key=b.wireless[c].key)});slp.bandSteeringProvided&&(gLocalAPInfo[BAND_STEER].wifi_enable=b.wireless.wlan_bs.wifi_enable,gLocalAPInfo[BAND_STEER].bs_enable=b.wireless.wlan_bs.bs_enable,gLocalAPInfo[BAND_STEER].ssid=b.wireless.wlan_bs.ssid,gLocalAPInfo[BAND_STEER].encryption=b.wireless.wlan_bs.encryption,
gLocalAPInfo[BAND_STEER].key=b.wireless.wlan_bs.key);gOldLanIP=gLanIP=b.network.lan.ipaddr;gLanIPMode=b.network.lan.ip_mode;for(var c=uciHostsInfo.optValue.linkType.wired,d=formatTableData(b.hosts_info.host_info),f=d.length,e=0;e<f;e++)if("1"==d[e].is_cur_host){switch(d[e].wifi_mode){case "0":curEqtBand=BAND_2G;break;case "1":curEqtBand=BAND_5G;break;case "2":curEqtBand=BAND_5G1;break;case "3":curEqtBand=BAND_5G2}slp.bandSteeringProvided&&"1"==gLocalAPInfo[BAND_STEER].bs_enable&&(curEqtBand=BAND_STEER);
bWirelessLinked=c!=d[e].type?!0:!1}c="idle";for(d=0;d<gRootAPInfo.length;d++)f=gKeyNames.wds_cfg_status[d],0<gRootAPInfo[d].ssid.length&&(curWdsBand=d,c=b.wireless[f].status);switch(c){case "idle":stepPage(firstPage);break;case "unfinished":loadingDialog.show({title:label.wdsOrgNetGuide,content:{primary:label.bridgingAndWait,secondary:null}},null,null,!0,function(){wdsCanceldHandle();stepPage(endPage,"WDSCon")});getDhcpsHd=$.setTimeout(wdsGetIpDhcpsStatus,100);break;case "connecting":loadingDialog.show({title:label.wdsOrgNetGuide,
content:{primary:label.bridgingAndWait,secondary:null}},null,null,!0,function(){wdsCanceldHandle();stepPage(endPage,"WDSCon")});wdsConClosed=!1;connectingCount=1;getWdsStatusHd=$.setTimeout(wdsStatusHd,100);break;case "connect_fail":if(0==parseInt(gRootAPInfo[curWdsBand].enable)){stepPage(endPage,"WDSCon");break}confirmDialog.show({title:label.wdsOrgNetGuide,content:label.linkFailed,callback:function(a){!0==a?(loadingDialog.show({title:label.wdsOrgNetGuide,content:{primary:label.bridgingAndWait,secondary:null}},
null,null,!0,function(){wdsCanceldHandle();stepPage(endPage,"WDSCon")}),wdsConClosed=!1,connectingCount=1,getWdsStatusHd=$.setTimeout(wdsStatusHd,100)):(wdsCanceldHandle(),stepPage(endPage))}});break;default:stepPage(endPage)}})}(function(){slp.modeSwitchSupport?checkBridgeStatus():init()})();
</script><style type="text/css">div.head.wdsStep{border-bottom-width:0}div.head ul.stepTab{display:none}div.head.wdsStep ul.stepTab{display:block}ul.stepTab{height:40px;width:auto;border-bottom:2px solid #e6e6e6;box-sizing:border-box;position:relative}ul.stepTab li.step{display:inline-block;height:40px;width:160px;line-height:40px;vertical-align:middle}ul.stepTab li.step i.stepNum{display:inline-block;width:16px;height:16px;border-radius:9px;background-color:#ccc;vertical-align:middle;line-height:16px;text-align:center;font-style:normal;font-size:12px;color:#fafafa;margin-right:6px}ul.stepTab li.step span{vertical-align:middle;line-height:40px;font-size:14px;color:#666}ul.stepTab li.step.active span{color:#000;font-weight:bold}#WDSCon{position:relative}div.wdsScanStepBtn{text-align:right;margin-top:48px}div.wdsBasicInfo{padding:23px;border:1px solid #e0e0e0}i.wdsBasicInfoPic{width:80px;height:80px;display:inline-block;margin-right:24px;vertical-align:top}div.wdsBasicInfoContent{display:inline-block;vertical-align:top}div.wdsBasicInfoContent ul.medium.wdsTextState,div.wdsBasicInfoContent div.wdsTextState ul{margin-bottom:4px}div.wdsBasicInfoContent ul label{vertical-align:top!important}div.wdsBasicInfoContent ul li{vertical-align:top!important}div.wdsBasicInfoContent ul li span{line-height:32px;min-height:32px;color:#666;font-size:13px;display:block;width:470px;word-break:break-all}i.wdsRootAp{background:url(../web-static/images/wds_bridge.png) no-repeat scroll}i.wdsLocalAp{background:url(../web-static/images/wds_router.png) no-repeat scroll}#switchCon{display:none}p#highsetTitleError{margin:16px 0}</style>