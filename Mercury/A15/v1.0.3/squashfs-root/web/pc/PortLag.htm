

<div class="head">
	<div class="title">
		<h1>{%menuStr.portLag%}</h1>
		<div id="lagSwitchCon" class="switchCon switchConHs">
			<i class="switchBg"></i>
			<i class="switchBall"/></i>
		</div>
	</div>
    <p class="description">{%titleDescriptionStr.portLagDescription%}</p>
</div>
<div class="selectLagPortWrapper">
    <p class="selectLagPortInfo disNone">{%label.selectLagPortInfo%}</p>
    <div id="routerList">
    </div>
    <div id="addLagRouter" class="disNone">
        <div id="addLagRouterBtn">
            <i class="iconfont icon-add"></i>
            <span class="addLagPort">{%label.addLagPort%}</span>
        </div>
        <span class="addLagRouterInfo">{%label.addLagRouterInfo%}</span>
    </div>
    <div id="portLagTips" class="disNone">{%label.portLagTips%}</div>
    <div class="buttonGroup">
        <div id="cancelSelect"></div>
        <div id="confirmSelect"></div>
    </div>
</div><script type="text/javascript">(function(){function g(){g.prototype.init=function(a){this.initData=[];this.lagCfg={};this.rootElementId=a;this.addedRouterList=[];this.lagEnable="0";var b=this;m=new Switch("lagSwitchCon",0,function(a){b.switchLagPortState.call(b,a)},!1)};g.prototype.refreshInitData=function(a){var b=this,c={};c[uciPortConfig.fileName]={};c[uciPortConfig.fileName][KEY_TABLE]=[];c[uciPortConfig.fileName][KEY_NAME]=[];c[uciPortConfig.fileName][KEY_TABLE][0]=uciPortConfig.secType.devInfo;c[uciPortConfig.fileName][KEY_NAME][0]=
uciPortConfig.secType.lag;$.query(c,function(c){var f;a:{f="";switch(c[ERR_CODE]){case ENONE:f=!0;break a;case EIPTVTABLEFULL:f=errStr.iptvTableFull;break;case EIPTVENTRYCONFLIC:f=errStr.iptvEntryConflict;break;case EIPTVENTRYNOTEXIST:f=errStr.iptvEntryNoExist;break;case EIPTVLINKMODEERROR:f=errStr.iptvLinkModeError;break;case EIPTVWORKMODEERROR:f=errStr.iptvWorkModeError;break;case EIPTVVLANIDERROR:f=errStr.iptvVlanIdError;break;case EIPTVWANINDEXERROR:f=errStr.iptvWanIndexError}alarmDialog.show(f);
f=!1}f&&(b.initData=c[uciPortConfig.fileName][uciPortConfig.secType.devInfo],b.lagCfg=c[uciPortConfig.fileName][uciPortConfig.secType.lag],b.lagEnable=b.lagCfg[uciPortConfig.optName.enable],a())})};g.prototype.refreshAddedListCfg=function(a){var b="1"==this.lagEnable?"display":"setting";this.addedRouterList=[];for(var c=this.getCapMac(),d=this.lagCfg[uciPortConfig.optName.lagList],f=!0,p=!1,e=this.initData,l=!1,g=0,h=0;h<e.length;h++){for(var k=e[h][uciPortConfig.dynOptName.phyInfo],n=g=0;n<k.length;n++)"lan"!=
k[n][uciPortConfig.dynOptName.role]&&"lag"!=k[n][uciPortConfig.dynOptName.role]||g++;2<=g&&(l=!0)}if(l){0==d.length&&(f=!1,p=!0);for(e=0;e<d.length;e++)for(l=d[e][uciPortConfig.optName.lagDev].toUpperCase(),g=d[e][uciPortConfig.optName.lagPhy],"FF-FF-FF-FF-FF-FF"==l&&(l=c),h=0;h<this.initData.length;h++)if(this.initData[h][uciPortConfig.dynOptName.mac]==l&&this.checkDataSetCfg(this.initData[h][uciPortConfig.dynOptName.phyInfo],g)){f=!1;break}if(f){d=this.lagCfg[uciPortConfig.optName.lagList];for(e=
0;e<d.length;e++)"FF-FF-FF-FF-FF-FF"==d[e][uciPortConfig.optName.lagDev]?this.addRouterItem(c):this.addRouterItem(d[e][uciPortConfig.optName.lagDev]),this.refreshDataSetCfg(this.addedRouterList[e].routerInitData.port,d[e][uciPortConfig.optName.lagPhy]);this.showRouterList(b);"undefined"!=typeof a&&a&&$("#confirmSelect").click()}else this.addRouterItem(c),this.showRouterList(b),p||alarmDialog.show(label.wanSettedBusy)}else alarmDialog.show(label.portLessErr),m.setState(0),$(".selectLagPortWrapper").hide()};
g.prototype.checkDataSetCfg=function(a,b){for(var c=!1,d=0;d<b.length;d++)"lan"!=a[parseInt(b[d])][uciPortConfig.dynOptName.role]&&"lag"!=a[parseInt(b[d])][uciPortConfig.dynOptName.role]&&(c=!0);return c};g.prototype.refreshDataSetCfg=function(a,b,c){JSON.parse(JSON.stringify(a));for(c=0;c<b.length;c++)"disable"!=a[parseInt(b[c])].state&&(a[parseInt(b[c])].name=label.lagPort,a[parseInt(b[c])].state="active")};g.prototype.getCapMac=function(){for(var a=0;a<this.initData.length;a++)if(this.initData[a][uciPortConfig.dynOptName.cap]==
uciPortConfig.dynOptValue.cap.cap)return this.initData[a][uciPortConfig.dynOptName.mac]};g.prototype.refreshPage=function(){var a=this;$(".selectLagPortInfo").hide();this.refreshInitData(function(){"1"==a.lagEnable?(m.setState(1),$(".selectLagPortWrapper").show(),a.refreshAddedListCfg()):(m.setState(0),$(".selectLagPortWrapper").hide())})};g.prototype.switchLagPortState=function(a){var b=this;"1"==a?($(".selectLagPortInfo").show(),$(".selectLagPortWrapper").show(),loadingDialog.show({title:menuStr.portLag,
content:{primary:label.wanSettingWait}}),b.refreshInitData(function(){b.refreshAddedListCfg(!0);loadingDialog.hide()})):($(".selectLagPortWrapper").hide(),loadingDialog.show({title:menuStr.portLag,content:{primary:label.wanSettingWait}}),a={},a[uciPortConfig.fileName]={},a[uciPortConfig.fileName][uciPortConfig.secType.lag]={},a[uciPortConfig.fileName][uciPortConfig.secType.lag][uciPortConfig.optName.enable]=uciPortConfig.optValue.enable.off,$.modify(a,function(a){loadingDialog.hide();a[ERR_CODE]==
ENONE?(showToast(label.portLagClose),b.refreshAddedListCfg()):(showToast(label.closeErr),$(".selectLagPortWrapper").show())}))};g.prototype.showRouterList=function(a){var b=this;$("#"+this.rootElementId).html("");for(var c=0;c<this.addedRouterList.length;c++){var d=$('<ul class="inputCMPT medium selectRouterUl"><li class="inputLi"><span class="selectWrap"><span id="routerSel'+c+'" class="select"><span class="value"></span><i class="arrow iconfont icon-folddropdown"></i></span></span></li><div class="deleteArea" id="'+
("deleteSel"+c)+'"><i class="iconfont icon-delete"></i><span>移除</span></div></ul>'),f=$('<div class="routerItemArea"></div>');"setting"==a&&($("#"+this.rootElementId).append(d),selectInit("routerSel"+c,this.addedRouterList[c].selectList,this.addedRouterList[c].mac,function(a,c){var d=c.id.slice(9,c.id.length);b.addedRouterList[d].mac!=a&&(b.addedRouterList[d].mac=a,b.addedRouterList[d].routerInitData=b.generatePhyInfo(a,b.initData,"LAG"),b.refreshSelectList(),b.showRouterList("setting"))}),2>this.addedRouterList.length?
$("#deleteSel"+c).remove():$("#deleteSel"+c).click(function(){b.delRouterItem(b.addedRouterList[this.id.slice(9,this.id.length)].mac)}));$("#"+this.rootElementId).append(f);this.addedRouterList[c].routerInitData.element=f[0];this.addedRouterList[c].routerInitData.type=a;this.addedRouterList[c].routerInitData.showRouterName="setting"==a?!1:!0;this.addedRouterList[c].routerInitData.callback=function(a){for(var c=0,d=0;d<this.port.length;d++)"active"==this.port[d].state&&c++;switch(a.state){case "disable":return;
case "normal":this.port[a.index].name="LAN";break;case "active":2>=c?this.port[a.index].name=label.lagPort:(this.port[a.index].state="normal",showToast(label.wanPortBusy))}b.showRouterList("setting")};(new PortConfig).init(this.addedRouterList[c].routerInitData)}"setting"==a?($("#addLagRouter").show(),$("#portLagTips").hide(),$(".routerItemArea").addClass("routerSettingArea"),this.addedRouterList.length==this.initData.length?($("#addLagRouter").addClass("disable"),$("#addLagRouterBtn").unbind("click")):
($("#addLagRouter").removeClass("disable"),$("#addLagRouterBtn").click(function(){b.addRouterItem();b.showRouterList("setting")}))):($("#portLagTips").show(),$(".routerItemArea").addClass("routerDisplayArea"),$("#addLagRouter").hide());b.initPageBtns(a)};g.prototype.refreshBtnState=function(){for(var a=!0,b=0;b<this.addedRouterList.length;b++){for(var c=0,d=0;d<this.addedRouterList[b].routerInitData.port.length;d++)"active"==this.addedRouterList[b].routerInitData.port[d].state&&c++;2>c&&(a=!1)}a?
k.disable(!1):k.disable(!0)};g.prototype.initPageBtns=function(a){var b=this;"setting"==a?($("#confirmSelect").show(),$("#confirmSelect").css("display","inline-block"),k=new Button({text:btn.finish,onClick:function(){loadingDialog.show({title:menuStr.portLag,content:{primary:label.wanSettingWait}});var a={};a[uciPortConfig.fileName]={};a[uciPortConfig.fileName][uciPortConfig.secType.lag]={};a[uciPortConfig.fileName][uciPortConfig.secType.lag][uciPortConfig.optName.enable]=uciPortConfig.optValue.enable.on;
for(var d=[],f=0;f<b.addedRouterList.length;f++){var g={};b.addedRouterList[f].mac==b.getCapMac()?g.lag_dev="FF-FF-FF-FF-FF-FF":g.lag_dev=b.addedRouterList[f].mac.toUpperCase();g.lag_phy=[];for(var e=0;e<b.addedRouterList[f].routerInitData.port.length;e++)"active"==b.addedRouterList[f].routerInitData.port[e].state&&g.lag_phy.push(e.toString());d.push(g)}a[uciPortConfig.fileName][uciPortConfig.secType.lag][uciPortConfig.optName.lagList]=d;$.modify(a,function(a){loadingDialog.hide();if(a[ERR_CODE]==
ENONE){for(a=0;a<b.addedRouterList.length;a++)b.addedRouterList[a].routerInitData.showRouterName=!0;b.showRouterList("display");$(".selectLagPortInfo").hide();showToast(label.portLagOpen)}else a[ERR_CODE]==ELAGDIFFERR?showToast(label.lagDiffErr):showToast(label.wanSetError)})},type:Button.TYPE.PRIMARY,id:"confirmSelect",props:{width:"120px",marginLeft:"8px"}})):$("#confirmSelect").hide();new Button({text:"setting"==a?btn.cancel:btn.reSelPort,onClick:function(){if("display"==a){for(var c=0;c<b.addedRouterList.length;c++)b.addedRouterList[c].routerInitData.showRouterName=
!1;b.showRouterList("setting");$(".selectLagPortInfo").show();$("#addLagRouter").show();$("#portLagTips").hide()}else b.refreshPage()},type:Button.TYPE.SECONDARY,id:"cancelSelect",props:{width:"120px"}});b.refreshBtnState()};g.prototype.delRouterItem=function(a){if(1!=this.addedRouterList.length){for(var b=0;b<this.addedRouterList.length;b++)if(this.addedRouterList[b].mac.toUpperCase()==a.toUpperCase()){this.addedRouterList.splice(b,1);break}this.refreshSelectList();this.showRouterList("setting")}};
g.prototype.addRouterItem=function(a){if(this.addedRouterList.length!=this.initData.length){var b;if("undefined"!=typeof a)b=a.toUpperCase();else for(a=0;a<this.initData.length;a++)-1==this.findItemByTag(this.initData[a].mac,this.addedRouterList,"mac")&&(b=this.initData[a].mac.toUpperCase());-1==this.findItemByTag(b,this.addedRouterList,"mac")&&(-1!=this.findItemByTag(b,this.initData,"mac")&&this.addedRouterList.push({mac:b.toUpperCase(),routerInitData:this.generatePhyInfo(b,this.initData,"LAG"),
selectList:[]}),this.refreshSelectList())}};g.prototype.refreshSelectList=function(){for(var a=0;a<this.addedRouterList.length;a++)this.addedRouterList[a].selectList=[];for(a=0;a<this.initData.length;a++)if(-1==this.findItemByTag(this.initData[a][uciPortConfig.dynOptName.mac],this.addedRouterList,"mac"))for(var b=0;b<this.addedRouterList.length;b++)this.addedRouterList[b].selectList.push({str:this.getCapMac()==this.initData[a][uciPortConfig.dynOptName.mac]?"[主路由]"+this.initData[a][uciPortConfig.dynOptName.name]:
this.initData[a][uciPortConfig.dynOptName.name],value:this.initData[a][uciPortConfig.dynOptName.mac]});else for(b=0;b<this.addedRouterList.length;b++)this.initData[a][uciPortConfig.dynOptName.mac]==this.addedRouterList[b].mac&&this.addedRouterList[b].selectList.push({str:this.getCapMac()==this.initData[a][uciPortConfig.dynOptName.mac]?"[主路由]"+this.initData[a][uciPortConfig.dynOptName.name]:this.initData[a][uciPortConfig.dynOptName.name],value:this.initData[a][uciPortConfig.dynOptName.mac]})};g.prototype.findItemByTag=
function(a,b,c){for(var d=0;d<b.length;d++)if(b[d][c]==a)return d;return-1};g.prototype.generatePhyInfo=function(a,b,c){for(var d,f=0;f<b.length;f++)b[f][uciPortConfig.dynOptName.mac].toUpperCase()==a.toUpperCase()&&(d=b[f]);return{port:this.initPortData(d,c),powerPos:d[uciPortConfig.dynOptName.powerPos],powerIdx:d[uciPortConfig.dynOptName.powerIdx],routerName:d[uciPortConfig.dynOptName.name],showRouterName:!1,showOffLine:d[uciPortConfig.dynOptName.online]==uciPortConfig.dynOptValue.online.offline}};
g.prototype.initPortData=function(a,b){for(var c=a[uciPortConfig.dynOptName.phyInfo],d=[],f=a[uciPortConfig.dynOptName.sfpCapability],g=c.length,e=0;e<g;e++)d[e]={};for(e=0;e<c.length;e++)c[e].role.slice(0,3).toUpperCase()==b?(d[e].state="active",d[e].name=PortConfig.prototype.transRoleName(c[e].role)):"LAN"==c[e].role.slice(0,3).toUpperCase()?(d[e].state="normal",d[e].name="LAN"):(d[e].state="disable",d[e].name=PortConfig.prototype.transRoleName(c[e].role)),d[e].rate=PortConfig.prototype.getPhySpeedByIndex(c,
e,f),d[e].isSfp="SFP"==c[e].type.toUpperCase();return d}}var k,m,q=new g;q.init("routerList");q.refreshPage()})();
</script><style type="text/css">.selectLagPortInfo{font-size:16px;color:#333;font-weight:bold}#addLagRouterBtn{display:inline-block;box-sizing:border-box;height:32px;padding:0 16px;border:1px solid #ccc;border-radius:4px;cursor:pointer;min-width:104px;text-align:center}#addLagRouterBtn i.iconfont{font-size:16px;vertical-align:middle;line-height:30px;color:#999}#addLagRouterBtn .addLagPort{line-height:30px;font-size:13px;vertical-align:middle;color:#333}#addLagRouter.disable #addLagRouterBtn{border:1px solid #e6e6e6}#addLagRouter.disable #addLagRouterBtn i.iconfont{color:#b3b3b3}#addLagRouter.disable #addLagRouterBtn span{color:#b3b3b3}.addLagRouterInfo{line-height:30px;font-size:13px;vertical-align:middle;color:#999;margin-left:7px}.deleteArea{display:inline-block;position:absolute;font-size:13px;left:254px;width:48px;top:7px;cursor:pointer}.deleteArea span{margin-left:2px}ul.selectRouterUl{margin-top:24px}#addLagRouter{margin-top:24px}.buttonGroup{margin-top:48px}.routerDisplayArea{margin-top:24px}#portLagTips{font-family:PingFangSC-Regular;font-size:13px;color:#999;letter-spacing:0;line-height:20px;font-weight:400;margin-top:16px}</style>