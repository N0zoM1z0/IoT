

<div class="head">
	<div class="title">
		<h1>{%menuStr.parentControl%}</h1>
		<i class="helpBtn iconfont icon-help" helpStr="parentControlHelp"></i>
		<div id="switchCon" class="switchCon switchConHs">
			<i class="switchBg"></i>
			<i class="switchBall"/></i>
		</div>
	</div>
	<p class="description">{%titleDescriptionStr.parentControlDescription%}</p>
</div>
<div id="parentMacTable"></div>
<div id="parentRuleTable" class="advanceTable"></div><script type="text/javascript">(function(){var p;function s(a){var c="";switch(a){case ENONE:return!0;case ETABLEFULL:c=errStr.tableFullErr;break;case ETABLEEMPTY:c=errStr.parentCtrlEmpty;break;case EENTRYNOTEXIST:c=errStr.entryNoExistErr;break;case EENTRYEXIST:c=errStr.entryExistErr;break;case EINVINSTRUCT:c=errStr.instructErr;break;case ESYSTEM:c=errStr.systemErr;break;case EFRTIMEPERIODBLANK:c=errStr.timePeriodBlank;break;case EFRTIMEPERIODTOOLONG:c=errStr.timePeriodTooLong;break;case EFRINVTPBEGINTIME:c=errStr.invTlBeginTime;
break;case EFRINVTPENDTIME:c=errStr.invTlEndTime;break;case EFRTIMEPERIODREPEATBLANK:c=errStr.tlRepeatBlank;break;default:c=errStr.unknown+a}alarmDialog.show(c);return!1}function L(a,c){var b={},f,d,h;void 0==a?(f=calcNextIndex(e),b.mode="add",b.index=f,b.name=label.timeSection+f,b.startHour=b.startMin=b.endHour=b.endMin="00",b.mon=b.tue=b.wed=b.thu=b.fri=b.sat=b.sun=!0):(f=a[SEC_NAME].replace(/.*_(\d)$/,"$1"),d=a[t].split(":"),h=a[v].split(":"),b.mode="edit",b.index=f,b.arrayIndex=c,b.itemName=a[SEC_NAME],
b.name=a.name,b.startHour=d[0],b.startMin=d[1],b.endHour=h[0],b.endMin=h[1],b.mon="0"==a[A]?!1:!0,b.tue="0"==a[B]?!1:!0,b.wed="0"==a[C]?!1:!0,b.thu="0"==a[D]?!1:!0,b.fri="0"==a[E]?!1:!0,b.sat="0"==a[F]?!1:!0,b.sun="0"==a[G]?!1:!0);return b}function M(a,c,b){var f,d,h=0,e=formatTableData(c);g=[];if(void 0==b||!0!=b)r=[],l=[];for(d=0;d<e.length;d++)1<parseInt(e[d][uciHostsInfo.dynOptName.type])||uciHostsInfo.optValue.isBlocked.yes==e[d][uciHostsInfo.dynOptName.blocked]||(f=""==e[d][uciHostsInfo.dynOptName.hostName]?
label.anonymousHost:e[d][uciHostsInfo.dynOptName.hostName],c=e[d][uciHostsInfo.dynOptName.mac].toUpperCase(),g[h]={name:f,mac:c},h++);if(void 0!=b&&!0==b)for(d=0;d<r.length;d++)for(c=r[d][uciFirewall.optName.srcMac].toUpperCase(),a=0;a<g.length;a++){if(c==g[a].mac){g.splice(a,1);break}}else for(r=formatTableData(a),d=0;d<r.length;d++){c=r[d][uciFirewall.optName.srcMac].toUpperCase();l[d]={name:"",mac:""};for(a=0;a<g.length;a++)if(c==g[a].mac){l[d].name=g[a].name;l[d].mac=g[a].mac;g.splice(a,1);break}""==
l[d].mac&&(l[d].name=label.anonymousHost,l[d].mac=c)}}function P(a){var c=a[uciFirewall.fileName][uciFirewall.secType.parentMac],b=a[uciFirewall.fileName][uciFirewall.secType.parentRule],f=a[uciFirewall.fileName][uciFirewall.secType.parentConfig],d=a[uciHostsInfo.fileName][uciHostsInfo.dynData.host_info];N&&a[uciHNat.fileName][uciHNat.secName.main][uciHNat.optName.enable]==uciHNat.optValue.enable.on&&(I=!0);u.setState(f[uciFirewall.optName.enable]);a=formatTableData(d)||[];for(var h=0;h<a.length;h++)if(f=
a[h],"1"==f[uciHostsInfo.optName.isCurHost]){p=f[uciHostsInfo.optName.mac].toUpperCase();break}M(c,d);w.setDataSource(g);w.loadData();J.setDataSource(l);J.loadData();e=formatTableData(b);c="";k=[];for(b=0;b<e.length;b++)c="",k[b]={},k[b][m]=e[b][m],k[b][SEC_NAME]=e[b][SEC_NAME],e[b][t]>e[b][v]&&(c=label.lBrackets+label.timePeriodNextDay+label.rBrackets),k[b].timeDesc=e[b][t]+label.timePeriodClose+"/"+c+e[b][v]+label.timePeriodOpen,k[b].weekDesc=("0"==e[b][A]?"":q.mon)+("0"==e[b][B]?"":q.tue)+("0"==
e[b][C]?"":q.wed)+("0"==e[b][D]?"":q.thu)+("0"==e[b][E]?"":q.fri)+("0"==e[b][F]?"":q.sat)+("0"==e[b][G]?"":q.sun);K.setDataSource(k);K.loadData()}function Q(){var a=w._getSelectItem(),c,b,f,d,e,y,n,k,q,p=a.selArr.length;if(0!=p){c=a.selArrStr.split("-");for(a=0;a<c.length;a++)for(var t=0;t<l.length;t++)if(l[t].mac.toUpperCase()==g[c[a]].mac.toUpperCase()){s(EENTRYEXIST);return}if(p+l.length>PARENT_DEVICE_NUM_MAX)s(ETABLEFULL);else if(1==p)y={},n={},k={},y[uciFirewall.fileName]=n,n[KEY_TABLE]=uciFirewall.secType.parentMac,
n[m]=n[KEY_TABLE]+"_"+calcNextIndex(r),n[KEY_PARA]=k,k[uciFirewall.optName.srcMac]=g[c[0]].mac,$.add(y,function(a){s(a[ERR_CODE])&&z.hide(function(){showToast(label.addSuccess);x()})});else{b=$.extend(!0,[],r);f=0;d=[];e="";var v=function(){loadingDialog.hide(function(){z.hide(function(){if(0==d.length)showToast(label.addSuccess);else{for(var a=0;a<d.length;a++)e+="<br />"+d[a];alarmDialog.show(label.entryBelowAddFail+e)}x()})})},u=function(a){y={};n={};k={};q={};y[uciFirewall.fileName]=n;n[KEY_TABLE]=
uciFirewall.secType.parentMac;n[m]=n[KEY_TABLE]+"_"+calcNextIndex(b);n[KEY_PARA]=k;k[uciFirewall.optName.srcMac]=g[c[a]].mac;$.add(y,function(e){f++;e[ERR_CODE]==ENONE?f<p?(q[SEC_NAME]=n[m],b.push(q),u(f)):v():(d.push(g[c[a]].name+label.lBrackets+g[c[a]].mac+label.rBrackets),f<p?u(f):v())},!0,!0)};loadingDialog.show({title:menuStr.parentControl,content:{primary:label.configging}},void 0,void 0,!1,void 0);u(f)}}}function R(){var a={};a[uciHostsInfo.fileName]={};a[uciHostsInfo.fileName][KEY_TABLE]=
uciHostsInfo.dynData.host_info;$.query(a,function(a){M(null,a[uciHostsInfo.fileName][uciHostsInfo.dynData.host_info],!0);w.setDataSource(g);w.loadData();showToast(label.refreshSuccess)})}function x(){var a={},c={},b={};a[uciFirewall.fileName]=c;c[KEY_TABLE]=[uciFirewall.secType.parentMac,uciFirewall.secType.parentRule];c[m]=uciFirewall.secName.parentConfig;a[uciHostsInfo.fileName]=b;b[KEY_TABLE]=uciHostsInfo.dynData.host_info;1==slp.moduleSpec.hnat&&(a[uciHNat.fileName]={},a[uciHNat.fileName][m]=
uciHNat.secName.main,N=!0);$.query(a,P)}var u,J,w,K,z;p=void 0;var r=[],l=[],g=[],e=[],k=[],H=uciFirewall.optValue.parentCtrl.enable,S=uciFirewall.optValue.parentCtrl.disable,m=uciTimeSwitch.optName.name,A=uciTimeSwitch.optName.mon,B=uciTimeSwitch.optName.tue,C=uciTimeSwitch.optName.wed,D=uciTimeSwitch.optName.thu,E=uciTimeSwitch.optName.fri,F=uciTimeSwitch.optName.sat,G=uciTimeSwitch.optName.sun,t=uciTimeSwitch.optName.startTime,v=uciTimeSwitch.optName.endTime,O=0,I=!1,N=!1,q={mon:label.one,tue:label.two,
wed:label.three,thu:label.four,fri:label.five,sat:label.six,sun:label.day};u=new Switch("switchCon",H,function(a){function c(){0==r.length?(u.setState(1-a),alarmDialog.show(errStr.parentCtrlEmpty)):(alarmDialog.show(label.parentCtrlNote),b())}function b(){f[uciFirewall.fileName]=d;d[uciFirewall.secName.parentConfig]=e;e[uciFirewall.optName.enable]=H==a?H:S;$.modify(f,function(a){s(a[ERR_CODE])})}var f={},d={},e={};H==a?I?confirmDialog.show({title:menuStr.parentControl,content:label.hNatCloseForParentControl,
callback:function(b){!0==b?(b={},b[uciHNat.fileName]={},b[uciHNat.fileName][uciHNat.secName.main]={},b[uciHNat.fileName][uciHNat.secName.main][uciHNat.optName.enable]=uciHNat.optValue.enable.off,$.modify(b,function(b){s(b[ERR_CODE])?(showToast(label.hNatClosed),I=!1,c()):u.setState(1-a)})):u.setState(1-a)}}):c():b()},!1);J=new Table({targetId:"parentMacTable",title:label.parentDev,head:[{field:label.deviceName,width:"0.65"},{field:label.mac,width:"0.35"}],column:[{name:"name",type:"str",onRender:function(a,
c){return void 0!=p&&a.mac.toUpperCase()==p?'<span style="color:#FF3366;margin-right:2px;">['+label.bHost+"]</span>"+c:c}},{name:"mac",type:"str"}],hasCheckBox:!0,editable:!1,addable:!1,max:PARENT_DEVICE_NUM_MAX,tableOption:[{icon:"icon-add",type:"add",str:btn.addDevice,func:function(){z.show()},selRelate:!1}],clickList:{click_del_item:{func:function(a,c){var b={},f={},d=[],e=a.split("-");b[uciFirewall.fileName]=f;f[m]=d;for(f=0;f<e.length;f++)d[d.length]=r[e[f]][SEC_NAME];confirmDialog.show({title:menuStr.parentControl,
content:e.length==l.length?label.allCanNotNettingWhenDelDevice+label.comma+label.confirmDelSelDevice+label.questionMark:1==e.length?label.canNotNettingWhenDelDevice+label.comma+label.confirmDelDevice+label.quota+l[e[0]].name+label.quota+label.questionMark:label.canNotNettingWhenDelDevice+label.comma+label.confirmDelSelDevice+label.questionMark,button:{confirmStr:btn.clear},callback:function(a){!0==a&&$.del(b,function(a){s(a[ERR_CODE])?(showToast(label.deleteSuccess),c(!0),x()):c(!1)})}})},asyn:!0}}});
z=new Dialog({title:label.selectParent+label.lBrackets+'<div class="selectCount" id="parentDevSelectNum">0</div>'+label.rBrackets,content:'<div class="selectParentTitleDesc"><span class="primary">'+label.parentSelectTitleDesc+'</span><span class="secondary">'+label.parentSelectTips+'</span></div><div id="hostInfoTable"></div>',size:component.Dialog.SIZE.MEDIUM,type:component.Dialog.TYPE.CUSTOM,hasCloseIcon:!0,bottom:[{type:component.Button.TYPE.SECONDARY,text:btn.cancelTip,id:"hostInfoTableCancel",
onClick:function(){z.hide()}},{type:component.Button.TYPE.PRIMARY,text:btn.confirmTip,id:"hostInfoTableSubmit",onClick:function(){Q()}}],renderCallBack:function(){w=new Table({targetId:"hostInfoTable",head:[{field:label.deviceName,width:"0.55"},{field:label.mac,width:"0.45"}],column:[{name:"name",type:"str",onRender:function(a,c){return void 0!=p&&a.mac.toUpperCase()==p?'<span style="color:#FF3366;margin-right:2px;">['+label.bHost+"]</span>"+c:c}},{name:"mac",type:"str"}],hasCheckBox:!0,editable:!1,
addable:!1,deletable:!1,max:O,tableOption:[{icon:"icon-refresh",type:"refresh",str:btn.refresh,func:R,selRelate:!1}],numPerPage:8});$(w).on("ev_sel_item",function(){var a=w._getSelectItem().selArr.length;$("#parentDevSelectNum").html(a)}).on("ev_sel_none",function(){$("#parentDevSelectNum").html(0)})}});K=new Table({targetId:"parentRuleTable",title:label.childDevLimit,head:[{field:label.periodDesc,width:"0.34"},{field:label.timeSection,width:"0.32"},{field:label.repeatWeek,width:"0.34"}],column:[{name:m,
type:"str"},{name:"timeDesc",type:"str"},{name:"weekDesc",type:"str"}],hasCheckBox:!0,editable:!1,addable:!1,max:PARENT_CONTROL_RULE_NUM_MAX,itemOption:[{icon:"icon-edit",type:"edit",str:btn.edit,func:function(a,c){var b=L(e[a],a);timePeriodDialog.show(b)}}],tableOption:[{icon:"icon-add",type:"add",str:btn.add,func:function(){var a=L();timePeriodDialog.show(a)},selRelate:!1}],clickList:{click_del_item:{func:function(a,c){var b={},f={},d=[];b[uciFirewall.fileName]=f;f[m]=d;for(var f=a.split("-"),h=
0;h<f.length;h++)d[d.length]=e[f[h]][SEC_NAME];$.del(b,function(a){s(a[ERR_CODE])&&(showToast(label.deleteSuccess),x())})},asyn:!0}}});O=slp.bandsProvided==slp.TRIPLE?(slp.moduleSpec.host_num_2g||0)+(slp.moduleSpec.host_num_5g_1||0)+(slp.moduleSpec.host_num_5g_4||0):slp.bandsProvided==slp.DOUBLE?(slp.moduleSpec.host_num_2g||0)+(slp.moduleSpec.host_num_5g||0):slp.moduleSpec.host_num_2g||0;timePeriodDialog.resetTpType(timePeriodDialog.tpType.PARENT_CONTROL);timePeriodDialog.resetCommit(function(a){for(var c=
0;c<e.length;c++)if((!1==a.mon?"0":"1")==e[c][A]&&(!1==a.tue?"0":"1")==e[c][B]&&(!1==a.wed?"0":"1")==e[c][C]&&(!1==a.thu?"0":"1")==e[c][D]&&(!1==a.fri?"0":"1")==e[c][E]&&(!1==a.sat?"0":"1")==e[c][F]&&(!1==a.sun?"0":"1")==e[c][G]&&a.startHour+":"+a.startMin==e[c][t]&&a.endHour+":"+a.endMin==e[c][v]&&(!a.arrayIndex||a.arrayIndex!=c)){showToast(label.sameRule);return}var c=[A,B,C,D,E,F,G],b={},f={},d={};b[uciFirewall.fileName]=f;"add"==a.mode?(f[KEY_TABLE]=uciFirewall.secType.parentRule,f[m]=f[KEY_TABLE]+
"_"+a.index,f[KEY_PARA]=d):f[a.itemName]=d;d[m]=a[m];for(f=0;f<c.length;f++)d[c[f]]=!0==a[c[f]]?"1":"0";d[t]=a.startHour+":"+a.startMin;d[v]=a.endHour+":"+a.endMin;"add"==a.mode?$.add(b,function(a){s(a[ERR_CODE])&&timePeriodDialog.hide(function(){showToast(label.addSuccess);x()})}):$.modify(b,function(a){s(a[ERR_CODE])&&timePeriodDialog.hide(function(){showToast(label.saveSuccess);x()})})});x()})();
</script><style type="text/css">div.selectParentTitleDesc{position:absolute;top:24px;left:24px}div.selectParentTitleDesc span{display:block;height:20px;line-height:20px;font-size:13px}div.selectParentTitleDesc span.primary{color:#333}div.selectParentTitleDesc span.secondary{color:#999}#hostInfoTable div.tableTitleContainer{margin-bottom:16px}</style>