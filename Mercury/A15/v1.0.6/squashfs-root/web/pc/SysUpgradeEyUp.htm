

<div class="head">
	<div class="title"><h1>{%menuStr.upgrade%}</h1><i class="helpBtn iconfont icon-help" helpStr="sysUpgradeHelp"></i></div>
	<p class="description">{%titleDescriptionStr.upgradeDescription%}</p>
</div>
<div class="subTitle">
	<h2>{%label.upgradeOnline%}</h2>
</div>
<span class="upgradeDesc">{%label.onlineEasyUpgradeNote%}</span>
<div id="upgradeOnlineTable">
</div>
<div class="subTitle">
	<h2>{%label.upgradeLocal%}</h2>
</div>
<span class="upgradeDesc">{%label.upgradeLocalDesc%}</span>
<div id="upgradeLocalTable">
</div><script type="text/javascript">(function(){function n(a){var b="";switch(a){case ENONE:return!0;case EFWEXCEPTION:b=errStr.fwException;break;case EFWRSAFAIL:b=errStr.fwRSAError;break;case EFWHWIDNOTMATCH:b=errStr.fwHwIdNotMatch;break;case EFWZONECODENOTMATCH:b=errStr.fwZoneCodeNotMatch;break;case EFWVENDORIDNOTMATCH:b=errStr.fwVendorIdNotMatch;break;case EFWNOTINFLANDBL:b=errStr.fwNotInFLAndBL;break;case EFWNEWEST:b=errStr.fwNewest;break;case EFWNOTSUPPORTED:b=errStr.fwNotSupported;break;case ECHIPID:b=errStr.fwChipIdNotSupport;
break;case EFLASHID:b=errStr.fwFlashIdNotSupported;break;case EMD5:b=errStr.fwMD5Err;break;case EINVFMT:b=errStr.fwFmtErr;break;case EPRODID:b=errStr.fwProdIdNotSupported;break;case ESUBVER:b=errStr.fwSubVerNotSupported;break;case ECOUNTRYID:b=errStr.fwCountryNotSupported;break;case EOEMID:b=errStr.fwOEmIdNotSupported;break;case ELANGID:b=errStr.fwLangNotSupported;break;case EFILETOOBIG:b=errStr.fileSizeErr;break;default:b=errStr.invRequestFail}alarmDialog.show(b);return!1}function U(a,b){if(!0!=
p)if(clearTimeout(upgradeTimeoutHd),upgradeTimeoutHd=null,a==ENONE){var c=b.wait_time?1E3*parseInt(b.wait_time):SYSUPGRADE_SECONDS;h.hide(function(){loadingDialog.show({title:label.upgradeLocal,content:{primary:label.upgrading,secondary:label.upgradingTips}},function(){lanDetecting(function(){window.location.reload()})},c,!1,void 0)})}else n(a)}function V(a,b){if(!0!=p)if(clearTimeout(upgradeTimeoutHd),upgradeTimeoutHd=null,a==ENONE){var c=b.wait_time?1E3*parseInt(b.wait_time):SYSUPGRADE_SECONDS;
h.hide(function(){loadingDialog.show({title:label.upgradeLocal,content:{primary:label.upgrading,secondary:label.upgradingExtTips}},function(){loadingDialog.hide(function(){u(function(a){f=$.extend(!0,[],a);m()})})},c,!1,void 0)})}else n(a)}function q(a,b){for(var c=0;c<a.length;c++)if(b.toUpperCase()==a[c].mac.toUpperCase())return{item:a[c],idx:c};return null}function N(a){for(var b=$(id("upgradeOnlineTable")).find("label.checkbox"),c=0,e=1;e<b.length;e++)f[b.length-e-1].checkboxDisabled?c++:(-1!=
b[e].className.indexOf("disabled")?!a&&$(b[e]).removeClass("disabled"):a&&$(b[e]).addClass("disabled"),-1!=b[e].className.indexOf("disabled")&&c++);c==b.length-1?$(b[0]).addClass("disabled"):$(b[0]).removeClass("disabled")}function r(a,b){a?(N(!0),$(id("upgradeOnlineTable")).find(".tableOption").addClass("disabled")):(N(!1),$(id("upgradeOnlineTable")).find(".tableOption.check").removeClass("disabled"))}function m(a,b){C.setDataSource(f);C.loadData();r(k,b);a||(v.setDataSource(f),v.loadData())}function O(a){a=
a.data;var b,c,e=ENONE;if(/(<pre>)?(.+)(<\/pre>)+/.test(a)||/(<pre>)?(.+)/.test(a))b=RegExp.$2;c=JSON.parse(b);e=c[ERR_CODE];e!=ENONE&&loadingDialog.hide();loadingDialog.hide(function(){V(e,c)})}function w(){p=!0;clearTimeout(upgradeTimeoutHd);loadingDialog.hide(function(){h.hide(function(){$(h.iframe).off("load");alarmDialog.show(errStr.upGradeFail)})})}function D(){P(function(a){Q(a);s?(m(!0),$.setTimeout(D,1E3)):u(function(a){for(var c,e=0;e<f.length;e++)f[e].checkFwVerStatus!=uciPlc.optValue.checkAllFwVerStatus.fail&&
(c=q(a,f[e].mac),null!=c?(c=c.item,f[e].cur_fw_version=c.cur_fw_version,f[e].newest_fw_version=c.newest_fw_version,f[e].isUpgradable=c.isUpgradable,f[e].status=c.status,f[e].checkboxDisabled=!c.isUpgradable,f[e].checkboxDisabledChecked=!1):f[e].status=f[e].isUpgradable?label.updatable:label.alreadyNewestVer);k=!1;m(!0)})})}function x(){k?$.setTimeout(x,3E3):autoRefreshGrid(function(){$.setTimeout(x,3E3)})}function R(a){var b,c,e,g=[];y=!1;for(var d=0;d<a.length;d++){if(a[d].status!=uciPlc.optValue.upgradeStatus.idle&&
(b=q(f,a[d].mac),E.toUpperCase(),null!=b)){c=b.item;if(c.isCap&&(a[d].status==uciPlc.optValue.upgradeStatus.downloading||a[d].status==uciPlc.optValue.upgradeStatus.downloadTimeout||a[d].status==uciPlc.optValue.upgradeStatus.downloadFail||a[d].status==uciPlc.optValue.upgradeStatus.waitForUpgrade||a[d].status==uciPlc.optValue.upgradeStatus.upgrading||a[d].status==uciPlc.optValue.upgradeStatus.upgradeFail||a[d].status==uciPlc.optValue.upgradeStatus.upgradeSuccess))return F=1E3*a[d].wait_time,G;if(!0!=
c.isCap&&"1"==c[uciPlc.optName.supportEyUp]){if(a[d].status==uciPlc.optValue.upgradeStatus.waitForUpgrade||a[d].status==uciPlc.optValue.upgradeStatus.upgrading)y=!0}else!0!=c.isCap&&"0"==c[uciPlc.optName.supportEyUp]&&(a[d].status==uciPlc.optValue.upgradeStatus.downloading||(a[d].status==uciPlc.optValue.upgradeStatus.waitForUpgrade||a[d].status==uciPlc.optValue.upgradeStatus.upgrading),y=!0);g.push(b.idx);a[d].status==uciPlc.optValue.upgradeStatus.waiting?e=label.waiting:a[d].status==uciPlc.optValue.upgradeStatus.downloading?
e="-1"!=a[d].download_progress?statusStr.fwDownloading+a[d].download_progress+"%":statusStr.fwDownloading:a[d].status==uciPlc.optValue.upgradeStatus.downloadTimeout?e=label.downloadTimeout:a[d].status==uciPlc.optValue.upgradeStatus.downloadFail?e=label.downloadFail:a[d].status==uciPlc.optValue.upgradeStatus.waitForUpgrade?e=label.waitingForUpgrade:a[d].status==uciPlc.optValue.upgradeStatus.upgrading?e="-1"!=a[d].upgrade_progress?label.upgradeing+a[d].upgrade_progress+"%":label.upgradeing:a[d].status==
uciPlc.optValue.upgradeStatus.upgradeFail?e=label.upgradeFail:a[d].status==uciPlc.optValue.upgradeStatus.upgradeSuccess&&(e=label.upgradeSuccess);c.status=e;c.upgradeStatus=a[d].status}a[d].mac.toUpperCase()==z.toUpperCase()&&H&&(S=a[d].wait_time)}return g}function I(){J(function(a){R(a)==G?(k=!1,m(!0),onlineUpgradeProgress(F)):t?(m(!0),$.setTimeout(I,1E3)):u(function(b){for(var c,e,g,d,h=0;h<a.length;h++)c=q(b,a[h].mac),e=q(f,a[h].mac),null!=e&&null!=c&&(g=c.item,d=e.item,d.cur_fw_version=g.cur_fw_version,
d.newest_fw_version=g.newest_fw_version,d.isUpgradable=g.isUpgradable,d.upgradeStatus!=uciPlc.optValue.upgradeStatus.downloadTimeout&&d.upgradeStatus!=uciPlc.optValue.upgradeStatus.downloadFail&&d.upgradeStatus!=uciPlc.optValue.upgradeStatus.upgradeFail?d.status=g.status:d.checkboxDisabled=!1),null==c&&null!=e&&f.splice(e.idx,1);k=!1;m()})})}function u(a){var b={};b[uciCloudConfig.fileName]={};b[uciCloudConfig.fileName][KEY_NAME]=[uciCloudConfig.secName.newFirmware,uciCloudConfig.secName.upgradeInfo];
b[uciDeviceInfo.fileName]={};b[uciDeviceInfo.fileName][KEY_NAME]=uciDeviceInfo.secName.info;b[uciProto.fileName]={};b[uciProto.fileName][KEY_NAME]=uciProto.secName.dhcp;b[uciPlc.fileName]={};b[uciPlc.fileName][KEY_TABLE]=uciPlc.secType.connectedExt;b[uciNetwork.fileName]={};b[uciNetwork.fileName][KEY_NAME]=uciNetwork.secName.lan;$.query(b,function(c){if(ENONE==c[ERR_CODE]){var b=c[uciDeviceInfo.fileName][uciDeviceInfo.secName.info],g=c[uciProto.fileName][uciProto.secName.dhcp][uciProto.optName.hostName],
d=c[uciCloudConfig.fileName][uciCloudConfig.secName.upgradeInfo],f=c[uciNetwork.fileName][uciNetwork.secName.lan],l,h=void 0==b[uciDeviceInfo.optName.swVer]?label.canNotDetect:b[uciDeviceInfo.optName.swVer],k=c[uciCloudConfig.fileName][uciCloudConfig.secName.newFirmware][uciCloudConfig.optName.fwNewNotify],k=checkNum(k)&&parseInt(k)||uciCloudConfig.optValue.fwNewFalse;l={};l.name=g;l.hw_version=b[uciDeviceInfo.optName.hwVer];l.cur_fw_version_full=h;l.cur_fw_version=h.split(" ")[0];l.isUpgradable=
k==uciCloudConfig.optValue.fwNewTrue&&void 0!=d[uciCloudConfig.optName.version];l.newest_fw_version=l.isUpgradable?d[uciCloudConfig.optName.version].split(" ")[0]:h.split(" ")[0];l.status=l.isUpgradable?label.updatable:label.alreadyNewestVer;l.mac=f[uciNetwork.optName.mac];l.isCap=!0;l.checkboxDisabled=!l.isUpgradable;l.checkboxDisabledChecked=!1;E=f[uciNetwork.optName.mac].toUpperCase();c=formatTableData(c[uciPlc.fileName][uciPlc.secType.connectedExt]);b=0;for(g=c.length;b<g;b++)d=c[b],d[uciPlc.optName.supportOlUp]!=
uciPlc.optValue.supportOlUp.yes?(d.name=d.name||label.oldVersion,d.cur_fw_version=label.canNotDetect,d.newest_fw_version=label.canNotDetect,d.cur_fw_version_full=label.canNotDetect,d.isUpgradable=!1,d.status=label.alreadyNewestVer):(d.name=void 0==d.name?label.canNotDetect:d.name,d.cur_fw_version_full=void 0==d.cur_fw_version?label.canNotDetect:d.cur_fw_version,d.cur_fw_version=""==d.cur_fw_version?label.canNotDetect:""==d.cur_fw_version.split(" ")[0]?label.canNotDetect:d.cur_fw_version.split(" ")[0],
d.newest_fw_version=void 0==d.newest_fw_version?d.cur_fw_version:d.newest_fw_version.split(" ")[0]||d.cur_fw_version,d.isUpgradable=d.cur_fw_version==label.canNotDetect||d.newest_fw_version==label.canNotDetect?!1:d.newest_fw_version!=d.cur_fw_version?!0:!1,d.status=d.isUpgradable?label.updatable:label.alreadyNewestVer),d.checkboxDisabled=!d.isUpgradable,d.checkboxDisabledChecked=!1;l=[l];l=c.concat(l);"function"==typeof a&&a(l)}})}function P(a){var b={};b[uciPlc.fileName]={};b[uciPlc.fileName][KEY_TABLE]=
uciPlc.secName.checkAllFwVer;$.query(b,function(c){var b=!1;if(c[ERR_CODE]!=ENONE){if(K)a:{s=K=!1,b=c[ERR_CODE];c="";switch(parseInt(b)){case ENONE:break a;case EINVSENDREQMSGFAILED:c=errStr.invSendReqMsgFailed;break;case ESYSBUSY:case EINVLASTOPTIONISNOTFINISHED:c=errStr.invLastOptionIsNotFinished;break;case ESYSTEM:c=errStr.invRequestFail;break;case ENOMEMORY:c=errStr.invMemoryOut;break;case EINVGETDATAFAILED:c=errStr.invGetDataFailed;break;case EINVPARAMETER:c=errStr.invParameter;break;case EINVMEMORYOUT:case EINVDOWNLOADFWFAILED:case EINVCONNECTTINGCLOUDSERVER:c=
errStr.fwDownLoadFailed;break;case EINVUPGRADEFWFAILED:c=errStr.fwUpgradeFailed;break;case EINVREQUESTTIMEOUT:c=appendErrCode(errStr.invRequestFailTrylater,b);break;case EINVDEVICEIDNOTEXIST:case EINVERRORDEVICEIDFORMATERROR:case EINVILLEGALDEVICE:c=appendErrCode(errStr.cloudDeviceInfoExpt,b);break;default:b=cloudErrHandle(b),c=!1==b.result?b.tip:errStr.invRequestFail}alarmDialog.show(c)}"function"==typeof a&&a([])}else{c=formatTableData(c[uciPlc.fileName][uciPlc.secName.checkAllFwVer]);for(var g=
0;g<c.length;g++)if(c[g].status==uciPlc.optValue.checkAllFwVerStatus.checking){b=!0;break}s=b;"function"==typeof a&&a(c)}})}function Q(a){for(var b,c,e,g=[],d=0;d<a.length;d++)b=q(f,a[d].mac),null!=b&&(c=b.item,g.push(b.idx),a[d].status==uciPlc.optValue.checkAllFwVerStatus.checking?e=label.checkingUpgrade:a[d].status==uciPlc.optValue.checkAllFwVerStatus.fail&&(e=label.checkVersionFail),c.status=e||c.status,c.checkFwVerStatus=a[d].status);return g}function J(a){var b=$.Deferred(),c=$.Deferred(),e=
{},g={};e[uciPlc.fileName]={};e[uciPlc.fileName][KEY_TABLE]=uciPlc.secName.upgradeDevStatus;$.query(e,function(a){b.resolve(a)},void 0,!0);g[uciHostsInfo.fileName]={};g[uciHostsInfo.fileName][KEY_TABLE]=uciHostsInfo.dynData.online_host;$.query(g,function(a){c.resolve(a)},void 0,!0);A=$.setTimeout(function(){A=null;B++;3<=B?(B=0,y&&!L&&(stopCloudRefresh(),loadingDialog.show({title:label.upgradeLocal,content:{primary:label.upgrading,secondary:label.upgradePopsWindowTips}},function(){loadingDialog.hide(function(){lanDetecting(function(){window.location.reload()})})},
1E3*S,!1,void 0),L=!0)):J(a)},2E3);$.when(b,c).done(function(b,c){var e,g=!1;if(!L){null!=A&&(clearTimeout(A),B=0);e=formatTableData(c[uciHostsInfo.fileName][uciHostsInfo.dynData.online_host]);for(var f=0;f<e.length;f++)"1"==e[f][uciHostsInfo.optName.isCurHost]&&(z=e[f][uciHostsInfo.optName.parentMac]);H=!1;z&&z.toUpperCase()!=E.toUpperCase()&&(H=!0);if(b[ERR_CODE]!=ENONE)M&&(t=M=!1,n(b[ERR_CODE])),"function"==typeof a&&a([]);else{e=formatTableData(b[uciPlc.fileName][uciPlc.secName.upgradeDevStatus]);
for(f=0;f<e.length;f++)if(e[f].status==uciPlc.optValue.upgradeStatus.waiting||e[f].status==uciPlc.optValue.upgradeStatus.downloading||e[f].status==uciPlc.optValue.upgradeStatus.waitForUpgrade||e[f].status==uciPlc.optValue.upgradeStatus.upgrading){g=!0;break}t=g;"function"==typeof a&&a(e)}}})}function T(){var a={};a[uciPlc.fileName]={};a[uciPlc.fileName][uciPlc.secName.checkAllFwVerStart]=null;k=!0;r(k);$.action(a,function(a){n(a[ERR_CODE])?(s=K=!0,D()):(k=!1,r(k))})}var p=!1,f=null,k=!1,H=!1,y=!1,
G=-1,F=SYSUPGRADE_SECONDS,E="",z="",S=0,B=0,A=null,L=!1,K=!1,M=!1,s=!1,t=!1,C,v;window.addEventListener?window.addEventListener("message",O,!1):window.attachEvent("onmessage",O);C=new Table({targetId:"upgradeOnlineTable",head:[{field:label.deviceName,width:"0.3"},{field:label.upCurrSoft,width:"0.25"},{field:label.upNewstSoft,width:"0.25"},{field:label.curStatus,width:"0.2"}],column:[{name:uciPlc.optName.name,type:"str"},{name:"cur_fw_version",type:"str"},{name:"newest_fw_version",type:"str"},{name:"status",
type:"str"}],tableOption:[{icon:"icon-refresh",type:"check",str:btn.checkVersion,func:T},{icon:"icon-localupdate",type:"upgrade",str:btn.easyUpgrade,func:function(){var a={},b=[],c=$(id("upgradeOnlineTable")).find("label.checkbox");confirmDialog.show({content:label.continueUpgradeConfirm,button:{confirmStr:btn.upgradeContinue},callback:function(e){if(e){a[uciPlc.fileName]={};a[uciPlc.fileName][uciPlc.secName.upgradeDev]={};a[uciPlc.fileName][uciPlc.secName.upgradeDev][uciPlc.optName.mac]=b;for(e=
1;e<c.length;e++){var g=c.length-e-1;-1!=c[e].className.indexOf("checked")&&(!0!=f[g].isUpgradable?$(c[e]).removeClass("checked"):b.push(f[g].mac.toUpperCase()))}k=!0;r(k);$.action(a,function(a){n(a[ERR_CODE])?(t=M=!0,I()):(k=!1,r(k))})}}})},selRelate:!0}],deletable:!1,editable:!1,addable:!1});v=new Table({targetId:"upgradeLocalTable",head:[{field:label.deviceName,width:"0.5"},{field:label.upCurrSoft,width:"0.5"}],column:[{name:uciPlc.optName.name,type:"str"},{name:"cur_fw_version",type:"str"}],itemOption:[{icon:"icon-localupdate",
type:"localUpdate",str:btn.upgradeLocal,func:function(a,b){h.show(v.data[a])}}],deletable:!1,editable:!1,addable:!1,hasCheckBox:!1});var h=new Dialog({title:label.upgradeLocal,content:'<span class="localUpgradeTitle">'+label.plzSelectSoftWareAndUpgrade+'</span><div id="importFile"></div>',size:Dialog.SIZE.SMALL,hasCloseIcon:!0,type:Dialog.TYPE.CUSTOM,bottom:[{type:component.Button.TYPE.SECONDARY,text:btn.cancelTip,id:"localUpgradeCancel",onClick:function(){h.hide()}},{type:component.Button.TYPE.PRIMARY,
text:btn.upgrade,id:"localUpgradeSubmit",onClick:function(){var a={};if(h.importFile.checkFile())if(upgradeTimeoutHd=$.setTimeout(w,4E4),h.currentRouter.isCap)a[uciSystem.fileName]={},a[uciSystem.fileName][uciSystem.actionName.firmUpgrade]={type:"0"},$.action(a,function(a){ENONE==a[ERR_CODE]?(h.importFile.submit($.orgURL(a.url)),p=!1):w()});else{var b="http://"+h.currentRouter.ip,c="undefined"!=typeof USERNAME_SUPPORT&&USERNAME_SUPPORT?{method:"do",login:{username:$.usr,password:$.pwd}}:{method:"do",
login:{password:$.pwd}},e,f;$.ajax({url:b,data:c,type:"POST",async:!0,postDataType:"json",dataType:"json",utf8Encode:!0,success:function(a){a[ERR_CODE]==ENONE?(f=a.stok,e=b+"/stok="+f+"/ds",c={},c[uciSystem.fileName]={},c[uciSystem.fileName][uciSystem.actionName.firmUpgrade]={type:"0"},c.method="do",$.ajax({url:e,data:c,type:"POST",async:!0,postDataType:"json",dataType:"json",utf8Encode:!0,success:function(a){a[ERR_CODE]==ENONE?(h.importFile.submit(b+"/stok="+f+a.url,!0),p=!1):w()},error:function(){loadingDialog.hide(function(){alarmDialog.show(errStr.invSendReqMsgFailed);
clearTimeout(upgradeTimeoutHd)})}})):w()},error:function(){loadingDialog.hide(function(){alarmDialog.show(errStr.invSendReqMsgFailed);clearTimeout(upgradeTimeoutHd)})}})}}}],renderCallBack:function(){this.importFile=new UpFile({targetId:"importFile",upLoadCallback:U,loadStr:{title:label.upgradeLocal,content:label.fwUploadTip}})}});h.currentRouter={isCap:!1,ip:""};h.show=function(a){this.currentRouter.isCap=a.isCap?!0:!1;this.currentRouter.ip=a.ip?a.ip:"";Dialog.prototype.show.call(this)};u(function(a){f=
$.extend(!0,[],a);P(function(a){s?(Q(a),k=!0,m(),D(),x()):J(function(a){t?(a=R(a),k=!0,m(),a==G?onlineUpgradeProgress(F):I()):(k=!1,m(),gOnlineUpgradeAuto&&(gOnlineUpgradeAuto=!1,T()));x()})})})})();
</script><style type="text/css">ul.inputCMPT li.input span.desc{font-size:13px;line-height:32px;color:#333}ul.inputCMPT li.input span.desc.upNew{color:#24b353}ul.cloudUpgrade label.outerLbl{vertical-align:top}span.localUpgradeTitle{line-height:20px;font-size:13px;color:#333}#importFile{margin-top:16px}span.upgradeDesc{display:block;margin-bottom:8px;color:#666;height:20px;line-height:20px;font-size:13px}</style>