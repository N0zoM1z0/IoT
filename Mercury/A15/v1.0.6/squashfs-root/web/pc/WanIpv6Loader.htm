

<div class="head">
	<div class="title">
		<h1>{%menuStr.ipv6%}</h1>
		<i class="helpBtn iconfont icon-help" helpStr="wanv6Help"></i>
		<div id="switchCon" class="switchCon switchConHs">
			<i class="switchBg"></i>
			<i class="switchBall"/></i>
		</div>
	</div>
	<p class="description">{%titleDescriptionStr.ipv6Description%}</p>
	<ul class="relayErrorTip">
		<i class="iconfont icon-warn"></i>
		<span id="relayTipText"></span>
	</ul>
	<div id="wanPortTab"></div>
</div>
<div id="ipv6Content">
	<div id="ipv6WanContent"></div>
	<div id="ipv6LanContent">
		<div class="subTitle">
			<h2>{%label.lanArguments%}</h2>
		</div>
		<ul class="inputCMPT medium selectUl">
			<label class="outerLbl">{%label.ipv6HostSetting%}</label>
			<li class="inputLi">
				<span class="selectWrap">
					<span id="hostSettingSel" class="select">
						<span class="value"></span>
						<i class="arrow iconfont icon-folddropdown"></i>
					</span>
				</span>
			</li>
		</ul>
		<div id="lanPrefix"></div>
		<div id="leaseTime"></div>
		<ul class="inputCMPT medium selectUl" id="lanv6DnsCon">
			<label class="outerLbl">{%label.ipv6DnsSetting%}</label>
			<li class="inputLi">
				<span class="selectWrap">
					<span id="dnsSettingSel" class="select">
						<span class="value"></span>
						<i class="arrow iconfont icon-folddropdown"></i>
					</span>
				</span>
			</li>
		</ul>
		<div id="lanv6StatusCon"></div>
		<div id="lanSave"></div>
	</div>
</div><script type="text/javascript">var curWanv6Type,wanStatusRefresh,lanStatusRefresh,setLanStatus,updateWanStatusTimer=null,updateLanStatusTimer=null,updateReconnectLanTimer=null,wanSelectRefreshTimer=null,localLanPrefixText="::",curLanv6LocalAddr="::",localLanPrefix,wanSelectRefreshCount=0,reconnectLanCount=0,RECONNECT_LAN_COUNT_MAX=3,preDelgOnFlag=!1,lanSave,btnSet=[],currentPppoeipGetPtlSel="",pppoePrefixSwitch,WAN_NUM=2,dualWanOpen=!1,WAN_IPV6_INDEX=1,dualWanTabCon,ROUTER_MODE=0,AP_MODE=1,WDS_MODE=2,curSysMode=ROUTER_MODE,startIp=
"4096",endIp="8192",wanv6Options=[{str:label.pppoe,value:LINK_TYPE_PPPOE},{str:label.staticIp,value:LINK_TYPE_STATIC_IP},{str:label.dhcpIpv6,value:LINK_TYPE_DHCP},{str:label.bridge,value:LINK_TYPE_BRIDGE}],lanv6HostSetOptions=[{str:label.ipv6DHCPv6,value:uciNetwork.optValue.ipv6LanProto.dhcp},{str:label.ipv6SLAAC,value:uciNetwork.optValue.ipv6LanProto.slaac}],lanv6DnsSetOptions=[{str:label.ipv6DHCPv6,value:uciNetwork.optValue.ipv6LanProto.slaac},{str:label.ipv6RDNSS,value:uciNetwork.optValue.ipv6LanProto.rdnss}];
function setLinkState(a,c){var d=$("#linkState");d[0].className=a?"normalState":"abnormalState";d.find("span.state").html(c)}function checkTime(){this.setValue(hideLeadingZeros(this.getValue()));if(!checkNum(this.input.value))return this.showNote(errStr.inputFmtErr),!1;2880<this.input.value?this.setValue((2880).toString()):1>this.input.value&&this.setValue((1).toString());return!0}
function IPv6Info(a){var c=0,d=0,g;a=a.replace(/：/g,":");g=a.match(/:+/g)||null;a.split(/:+/g);for(a=0;a<g.length;a++)":"==g[a]?d++:"::"==g[a]&&c++;return{singleColonCounts:d,doubleColonCounts:c}}function IPv6InitObj(a){var c=IPv6Info(a);a=a.replace("::",Array(7-c.singleColonCounts+1).join(":")).split(":");for(c=0;c<a.length;c++)a[c]=4>a[c].length?"0x"+Array(4-a[c].length+1).join("0")+a[c]:"0x"+a[c];return a}
function checkIPv6Input(a){var c=this.getValue().replace(/：/g,":");this.setValue(c);switch(checkIPv6(c,a)){case ENONE:return!0;case EIPV6INVIPFMT:return this.showNote(errStr.inputIpv6AddrErr),!1;case EIPV6LINKLOCAL:return this.showNote(errStr.inputIpv6LinkLocalErr),!1;case EIPV6LOOP:return this.showNote(errStr.inputIpv6AddrLoopErr),!1;case EIPV6INVIP:return this.showNote(errStr.inputIpv6AddrErr),!1;case EIPV6INVGROUPIP:return this.showNote(errStr.inputIpv6AddrGroupErr),!1;default:return!0}}
function checkGatewatV6(){var a=this.getValue().replace(/：/g,":");this.setValue(a);return checkIPv6(a,slp.gIpv6HostCtrlSupport?{allow_localLink:!0,allow_localSole:!0}:{allow_localLink:!0})!=ENONE?(this.showNote(errStr.inputGatewayErr),!1):!0}function checkPriDnsV6(){var a=this.getValue().replace(/：/g,":");this.setValue(a);return checkIPv6(a,slp.gIpv6HostCtrlSupport?{allow_localSole:!0}:void 0)!=ENONE?(this.showNote(errStr.wzdPrimDnsErr),!1):!0}
function checkSndDnsV6(){if(""==this.getValue()||"::"==this.getValue())return!0;var a=this.getValue().replace(/：/g,":");this.setValue(a);return checkIPv6(a,slp.gIpv6HostCtrlSupport?{allow_localSole:!0}:void 0)!=ENONE?(this.showNote(errStr.wzdSeDnsErr),!1):!0}
function checkLanPrefix(){var a=this.getValue().replace(/：/g,":");this.setValue(a);if("::"==a)return!0;var c=checkIPv6(a,slp.gIpv6HostCtrlSupport?{allow_localSole:!0}:void 0);if(c!=ENONE){switch(c){case EIPV6INVIP:this.showNote(errStr.ipv6PrefixErr);break;case EIPV6INVIPFMT:case EIPV6INVPREFIX:this.showNote(errStr.inputIpv6PrefixFmtErr);break;case EIPV6INVGROUPIP:this.showNote(errStr.ipv6PrefixGroupErr);break;case EIPV6LOOP:this.showNote(errStr.ipv6PrefixLoopErr);break;case EIPV6LINKLOCAL:this.showNote(errStr.ipv6PrefixLinkLoaclErr)}return!1}a=
IPv6InitObj(a);return 0!=a[4]||0!=a[5]||0!=a[6]||0!=a[7]?(this.showNote(errStr.inputIpv6PrefixFmtErr),!1):!0}function wanCheckWDS(a,c){slp.wds.getData({success:function(d){var g,e=!1,f;for(f in d[uciWireless.fileName])if(d[uciWireless.fileName].hasOwnProperty(f)&&(g=d[uciWireless.fileName][f],1==g[uciWireless.dynOptName.enable])){e=!0;break}e?(alarmDialog.show({content:label.wanWDSTip}),"function"==typeof c&&c()):"function"==typeof a&&a()},fail:function(){"function"==typeof a&&a()}})}
function loadPageByIndex(a,c){function d(a){wanSelectRefreshCount++;4<wanSelectRefreshCount?(wanSelectRefreshCount=0,wanSelectRefreshTimer=null):(g(a),wanSelectRefreshTimer=$.setTimeout(function(){d(a)},2E3))}function g(c){loadPage(e[a],"ipv6WanContent",function(){null!=wanSelectRefreshTimer&&(clearTimeout(wanSelectRefreshTimer),wanSelectRefreshTimer=null);wanSelectRefreshCount=0;a==LINK_TYPE_BRIDGE?($("#ipv6LanContent").css("display","none"),$("#lanv6HelpType").css("display","none")):($("#ipv6LanContent").css("display",
"block"),$("#lanv6HelpType").css("display","block"))})}var e=["DynamicIpv6.htm","StaticIpv6.htm","PPPoEIpv6.htm"];e[LINK_TYPE_BRIDGE]="BridgeIpv6.htm";""==a.toString()&&(a=LINK_TYPE_PPPOE);setHelpStr(a);g(c);wanSelectRefreshTimer=$.setTimeout(function(){d(c)},2E3)}
function setHelpStr(a){switch(a){case LINK_TYPE_DHCP:$("#wanv6HelpType").html($("#dynamicIpv6Help").html());break;case LINK_TYPE_STATIC_IP:$("#wanv6HelpType").html($("#staticIpv6Help").html());break;case LINK_TYPE_PPPOE:$("#wanv6HelpType").html($("#PPPoEv6Help").html());break;case LINK_TYPE_BRIDGE:$("#wanv6HelpType").html($("#Bridgev6Help").html());break;case uciNetwork.optValue.ipv6LanProto.dhcp:$("#lanv6HelpType").html($("#lanHostDhcpv6Help").html());break;case uciNetwork.optValue.ipv6LanProto.slaac:$("#lanv6HelpType").html($("#lanHostSlaacHelp").html())}loadPageHandleBg()}
function disableAllBtn(a){for(var c=0;c<btnSet.length;c++)(a||!1!=btnSet[c].autoEnable)&&btnSet[c].btn.disable(a)}
(function(){function a(a){var b="";switch(a){case ENONE:return!0;case EIPV6INVIP:b=errStr.ipv6PrefixErr;break;case EIPV6INVIPFMT:b=errStr.ipv6AddrFmtErr;break;case EIPV6INVGROUPIP:b=errStr.ipv6PrefixGroupErr;break;case EIPV6LOOP:b=errStr.ipv6PrefixLoopErr;break;case EIPV6INVPREFIX:b=errStr.inputIpv6PrefixFmtErr;break;case EINVLEASETIME:b=errStr.dhcpsLeaseErr;break;case EIPV6LINKLOCAL:b=errStr.ipv6PrefixLinkLoaclErr;break;default:b=errStr.invRequestFail}alarmDialog.show(b);return!1}function c(a){var b=
{},h;b[uciProto.fileName]={};h="undefined"!=typeof a&&2==a?uciProto.secName.wanv62:uciProto.secName.wanv6;b[uciProto.fileName][KEY_NAME]=h;$.query(b,function(b){b=b[uciProto.fileName][h][uciProto.optName.type];var c=LINK_TYPE_PPPOE;curWanv6Type=b;switch(b){case uciProto.optValue.proto.dynIpv6:case uciProto.optValue.proto.dynIpv62:c=LINK_TYPE_DHCP;break;case uciProto.optValue.proto.staticIpv6:case uciProto.optValue.proto.staticIpv62:c=LINK_TYPE_STATIC_IP;break;case uciProto.optValue.proto.bridgev6:c=
LINK_TYPE_BRIDGE;break;default:c=LINK_TYPE_PPPOE}loadPageByIndex(c,a)})}function d(a){var b={};b[uciNetwork.fileName]={};b[uciNetwork.fileName][KEY_NAME]=uciNetwork.dynData.lanv6Status;b[uciProto.fileName]={};b[uciProto.fileName][KEY_NAME]=[uciProto.secName.dhcpsv6,uciProto.secName.slaac,uciProto.secName.rdnss];$.query(b,function(b){var c=b[uciNetwork.fileName][uciNetwork.dynData.lanv6Status],m=b[uciProto.fileName][uciProto.secName.dhcpsv6],d=b[uciProto.fileName][uciProto.secName.slaac];b=b[uciProto.fileName][uciProto.secName.rdnss];
var e,f;c[uciNetwork.optName.proto]==uciNetwork.optValue.ipv6LanProto.dhcp?(e=uciNetwork.optValue.ipv6LanProto.dhcp,f=uciNetwork.optValue.ipv6LanProto.slaac,localLanPrefixText=m[uciProto.optName.prefix]):c[uciNetwork.optName.proto]==uciNetwork.optValue.ipv6LanProto.slaac?(e=uciNetwork.optValue.ipv6LanProto.slaac,f=c[uciNetwork.optName.proto],localLanPrefixText=d[uciProto.optName.prefix]):(e=uciNetwork.optValue.ipv6LanProto.slaac,f=c[uciNetwork.optName.proto],localLanPrefixText=b[uciProto.optName.prefix]);
selectInit("hostSettingSel",lanv6HostSetOptions,e,g);g(e);selectInit("dnsSettingSel",lanv6DnsSetOptions,f);lanLeaseTime.setValue(parseInt(m[uciProto.optName.leaseTime])/60);startIp=m[uciProto.optName.startIp];endIp=m[uciProto.optName.endIp];localLanPrefix.setValue(localLanPrefixText);setLanStatus(c);lanStatusRefresh(a)})}function g(a){a==uciNetwork.optValue.ipv6LanProto.dhcp?($("#leaseTime").css("display","block"),$("#lanv6DnsCon").css("display","none")):($("#leaseTime").css("display","none"),$("#lanv6DnsCon").css("display",
"table"));setHelpStr(a)}function e(a){var b={},h;b[uciProto.fileName]={};h="undefined"!=typeof a&&2==a?uciProto.secName.ipv6Info2:uciProto.secName.ipv6Info;b[uciProto.fileName][KEY_NAME]=h;$.query(b,function(b){l=b[uciProto.fileName][h][uciProto.optName.enable]==uciProto.optValue.ipv6Enable.on?SWITCH_ON:SWITCH_OFF;"undefined"!=typeof a&&2==a?p.setState(l):q.setState(l);$("#ipv6Content").css("display",l==SWITCH_ON?"block":"none");l==SWITCH_ON?(c(a),d(a),$("i.helpBtn").css("display","block")):$("i.helpBtn").css("display",
"none")})}function f(a){var b={},c;b[uciNetwork.fileName]={};c="undefined"!=typeof a&&2==a?uciNetwork.secName.ipv6SwitchStatus2:uciNetwork.secName.ipv6SwitchStatus;b[uciNetwork.fileName][KEY_NAME]=c;$.query(b,function(b){var d=b[ERR_CODE];d==ENONE?(b=b[uciNetwork.fileName][c][uciNetwork.optName.status],b==uciNetwork.optValue.ipv6SwitchStatus.success?k?("showed"!=loadingDialog.status?$.setTimeout(function(){loadingDialog.hide(function(){e(a)})},500):loadingDialog.hide(function(){e(a)}),k=!1):e(a):
(k||(loadingDialog.show({content:{primary:label.switchingConfig}}),k=!0),$.setTimeout(function(){f(a)},1E3))):alarmDialog.show(d)})}function s(a,b){slp.gMulWanSupport?$.query({port_manage:{table:"mwan"}},function(c){if(c[ERR_CODE]==ENONE){dualWanOpen=!0;for(var d=0;d<WAN_NUM;d++)0==c.port_manage.mwan[d]["mwan_"+(d+1)].enable&&(dualWanOpen=!1);dualWanOpen?a():b()}}):(dualWanOpen=!1,b())}function t(){wanv6Options.pop();$("#switchCon").remove();$(".dualWanHead").after('<div id="ipv6WanCon1" class="ipv6WanCon"><label>WAN1口IPv6</label><div id="switchCon" class="switchCon switchConHs">\t\t\t\t<i class="switchBg"></i>\t\t\t\t<i class="switchBall"/></i>\t\t\t</div></div>');
$(".dualWanHead").after('<div id="ipv6WanCon2" class="ipv6WanCon"><label>WAN2口IPv6</label><div id="switchCon2" class="switchCon switchConHs">\t\t\t\t<i class="switchBg"></i>\t\t\t\t<i class="switchBall"/></i>\t\t\t</div></div>');n(1);n(2);dualWanTabCon=new Tab({list:[{name:label.wan1Port,onClick:function(){WAN_IPV6_INDEX=1;$("#ipv6WanCon1").show();$("#ipv6WanCon2").hide();f(WAN_IPV6_INDEX)}},{name:label.wan2Port,onClick:function(){WAN_IPV6_INDEX=2;$("#ipv6WanCon1").hide();$("#ipv6WanCon2").show();
f(WAN_IPV6_INDEX)}}],targetId:"wanPortTab"})}function n(a){"undefined"!=typeof a&&2==a?p=new Switch("switchCon2",0,function(b){r(b,a)},!1):q=new Switch("switchCon",0,function(b){r(b,a)},!1)}function r(a,b){var c={},d=this;c[uciProto.fileName]={};c[uciProto.fileName][uciProto.action.switchIpv6]={};c[uciProto.fileName][uciProto.action.switchIpv6][uciProto.optName.enable]=1==a?uciProto.optValue.ipv6Enable.on:uciProto.optValue.ipv6Enable.off;"undefined"!=typeof b&&2==b&&(c[uciProto.fileName][uciProto.action.switchIpv6][uciProto.optName.index]=
"2");loadingDialog.show({content:{primary:label.switchingConfig}});k=!0;$.action(c,function(c){c[ERR_CODE]==ENONE?(updateWanStatusTimer&&(clearTimeout(updateWanStatusTimer),updateWanStatusTimer=null),updateLanStatusTimer&&(clearTimeout(updateLanStatusTimer),updateLanStatusTimer=null),f(b)):(d.setState(1-a),loadingDialog.hide(function(){alarmDialog.show(label.ipv6CurentSwitching);k=!1}))})}var q,p,k=!1,l;lanStatusRefresh=function(a){var b={};b[uciNetwork.fileName]={};b[uciNetwork.fileName][KEY_NAME]=
uciNetwork.dynData.lanv6Status;null!=updateLanStatusTimer&&clearTimeout(updateLanStatusTimer);updateReconnectLanTimer||(clearTimeout(updateReconnectLanTimer),updateReconnectLanTimer=null);updateReconnectLanTimer=$.setTimeout(function(){reconnectLanCount++;reconnectLanCount<=RECONNECT_LAN_COUNT_MAX?lanStatusRefresh(a):reconnectLanCount=0},5E3);$.query(b,function(b){updateReconnectLanTimer&&(clearTimeout(updateReconnectLanTimer),updateReconnectLanTimer=null,0!=reconnectLanCount&&(updateWanStatusTimer=
$.setTimeout(function(){wanStatusRefresh(a)},0)),reconnectLanCount=0);setLanStatus(b[uciNetwork.fileName][uciNetwork.dynData.lanv6Status]);updateLanStatusTimer=$.setTimeout(function(){lanStatusRefresh(a)},2E3)},void 0,!0)};setLanStatus=function(a){u.setValue(a[uciNetwork.optName.priDns]);v.setValue(a[uciNetwork.optName.sndDns]);w.setValue(a[uciNetwork.optName.ipv6]);x.setValue(a[uciNetwork.optName.ipv6Local]);curLanv6LocalAddr=a[uciNetwork.optName.ipv6Local];$(localLanPrefix.dom).find("li.inputLi").hasClass("static")&&
localLanPrefix.setValue(a[uciNetwork.optName.prefix]+"/64")};localLanPrefix=new Input({type:Input.TYPE.PLAIN_TEXT,label:{value:label.ipv6Pre},targetId:"lanPrefix",className:"bigLen",tips:{value:"/64",className:"unit"},check:{blur:checkLanPrefix},props:{maxlength:"39",type:"text"}});lanLeaseTime=new Input({type:Input.TYPE.PLAIN_TEXT,label:{value:label.ipv6AddrLease},targetId:"leaseTime",tips:{value:label.unitMinute,className:"unit"},hint:{value:label.ipv6AddrLeaseTip},check:{blur:checkTime},props:{maxlength:"4",
type:"text"}});var u=new Input({type:Input.TYPE.STATIC_TEXT,label:{value:label.preferredDnsServer},targetId:"lanv6StatusCon",className:"bigLen",props:{value:"::",maxlength:"39",type:"text"}}),v=new Input({type:Input.TYPE.STATIC_TEXT,label:{value:label.alternativeDnsServer},targetId:"lanv6StatusCon",className:"bigLen",props:{value:"::",maxlength:"39",type:"text"}}),w=new Input({type:Input.TYPE.STATIC_TEXT,label:{value:label.ipv6LanGlobalAddr},targetId:"lanv6StatusCon",className:"bigLen",props:{value:"::/64",
maxlength:"39",type:"text"}}),x=new Input({type:Input.TYPE.STATIC_TEXT,label:{value:label.ipv6LanLocalAddr},targetId:"lanv6StatusCon",className:"bigLen",props:{value:"::/64",maxlength:"39",type:"text"}});lanSave=new Button({text:btn.save,onClick:function(){function c(){var b={},d={},e;e=id("hostSettingSel").value==uciNetwork.optValue.ipv6LanProto.dhcp?uciNetwork.optValue.ipv6LanProto.dhcp:id("dnsSettingSel").value;b[uciProto.fileName]={};b[uciProto.fileName][uciProto.secName.lanv6]={};b[uciProto.fileName][uciProto.secName.lanv6][uciProto.optName.proto]=
e;b[uciProto.fileName][e]=d;preDelgOnFlag||(d[uciProto.optName.prefix]=localLanPrefix.getValue());d[uciProto.optName.prefixLen]="64";e==uciNetwork.optValue.ipv6LanProto.dhcp&&(preDelgOnFlag||(d[uciProto.optName.startIp]=startIp,d[uciProto.optName.endIp]=endIp),d[uciProto.optName.leaseTime]=60*parseInt(lanLeaseTime.getValue()));null!=updateWanStatusTimer&&(clearTimeout(updateWanStatusTimer),updateWanStatusTimer=null);null!=updateLanStatusTimer&&(clearTimeout(updateLanStatusTimer),updateLanStatusTimer=
null);disableAllBtn(!0);$.modify(b,function(b){disableAllBtn(!1);b[ERR_CODE]==ENONE?showToast(label.saveSuccess):a(b[ERR_CODE]);curWanv6Type==uciProto.optValue.proto.pppoev6&&pppoePrefixSwitch.disable(currentPppoeipGetPtlSel==uciProto.optValue.ipv6Allot["static"]);updateWanStatusTimer=$.setTimeout(function(){wanStatusRefresh(WAN_IPV6_INDEX)},0);updateLanStatusTimer=$.setTimeout(function(){lanStatusRefresh(WAN_IPV6_INDEX)},0)})}var b=[],d=!0;id("hostSettingSel").value==uciNetwork.optValue.ipv6LanProto.dhcp&&
b.push(lanLeaseTime);preDelgOnFlag?(b.forEach(function(a){d=a.checkAll()&&d}),d&&c()):(b.push(localLanPrefix),b.forEach(function(a){d=a.checkAll()&&d}),d&&(b=localLanPrefix.getValue(),ipv6Compare(b,localLanPrefixText)?c():confirmDialog.show({content:label.ipv6LanPreChgTip,callback:function(a){a&&c()}})))},type:Button.TYPE.PRIMARY,id:"lanSave",props:{width:"240px",margin:"12px 0 0 132px"}});(function(a){slp.gSysModeSupport?$.query({system:{name:"sys_mode"}},function(b){curSysMode=b.system.sys_mode.mode;
curSysMode!=ROUTER_MODE?($(".relayErrorTip").show(),curSysMode==AP_MODE?$("#relayTipText").text("上网方式为AP（有线中继）时，无法使用IPv6功能。"):$("#relayTipText").text("上网方式为桥接（无线中继）时，无法使用IPv6功能。"),$("#switchCon").hide()):"function"==typeof a&&a()}):"function"==typeof a&&a()})(function(){s(function(){$("#menuLoader .head").addClass("dualWanHead");t()},function(){$("#menuLoader .head").removeClass("dualWanHead");n();f(WAN_IPV6_INDEX)})})})();
</script><style type="text/css">div.dualWanHead{margin-bottom:16px}span.normalState i.disc{background:#24b353}span.normalState span.state{color:#24b353}span.abnormalState i.disc{background:#f36}span.abnormalState span.state{color:#f36}div.buttonGroup{padding:12px 0 0 132px;font-size:0}#ipv6Content{display:none}li.liSwitchCon{display:table-cell}li.liSwitchCon:before{content:'';display:inline-block;vertical-align:middle;height:32px}li.liSwitchCon div.switchConHs{margin-left:0}div.ipv6WanCon{margin-top:48px}div.ipv6WanCon label{font-weight:bold;font-size:16px}#wanPortTab ul{border-bottom:2px solid #e6e6e6}#wanPortTab ul>li{width:160px}#wanPortTab .underline{bottom:-2px}</style>