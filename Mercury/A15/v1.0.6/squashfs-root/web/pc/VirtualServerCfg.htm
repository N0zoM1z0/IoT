
<div class="head">
	<div class="title">
		<h1>{%menuStr.virtualS%}</h1>
		<i class="helpBtn iconfont icon-help" helpStr="virtualServerCfgHelp"></i>
	</div>
	<p class="description">{%titleDescriptionStr.virtualServerDescription%}</p>
	<ul class="relayErrorTip">
		<i class="iconfont icon-warn"></i>
		<span id="relayTipText"></span>
	</ul>
</div>
<div id="virtualServerTable"></div><script type="text/javascript">(function(){function m(c){var b="";switch(c){case ENONE:return!0;case EINVNET:b=errStr.ipAddrNetErr;break;case EINVIP:b=errStr.ipAddrErr;break;case EINVIPFMT:b=errStr.ipAddrFmtErr;break;case EINVGROUPIP:b=errStr.ipAddrGroupErr;break;case EINVLOOPIP:b=errStr.ipAddrLoopErr;break;case EIPV6LINKLOCAL:b=errStr.ipv6PrefixLinkLoaclErr;break;case EIPV6INVIP:b=errStr.inputIpv6AddrErr;break;case EIPV6LOOP:b=errStr.ipv6PrefixLoopErr;break;case EIPV6INVGROUPIP:b=errStr.ipv6PrefixGroupErr;break;case EOVERFLOW:case EINVPORT:b=
errStr.invPortErr;break;case EINVPTC:b=errStr.invProtoErr;break;case EPORTRESERVED:b=errStr.portConflicErr;break;case ETABLEFULL:b=errStr.tableFullErr;break;case EENTRYNOTEXIST:b=errStr.entryNoExistErr;break;case EILLEGALPORT:b=errStr.portIllegalErr;break;case ENOTLANSUBNET:b=errStr.ipNotLanSubnet;break;case ELANIPCONFLIC:b=errStr.lanConflictErr;break;case EINVNETID:b=errStr.ipAddrNetIdErr;break;case EINVHOSTID:b=errStr.ipAddrHostIdErr;break;default:b=errStr.unknown+c}alarmDialog.show(b);return!1}
function r(c,b){c=b.value;var a=h.editTrObj[1].container,e=n?h.editTrObj[5].container:h.editTrObj[4].container;a.setValue(-1!=c&&-2!=c?c:"");for(var k in d)d.hasOwnProperty(k)&&d[k].value==c&&e.changeSel(d[k].protocol);a.closeNote()}function v(c,b){var a,e;for(e in l)if(l.hasOwnProperty(e)&&(a=l[e],e!=b))if(a.vsOpenPortS==a.vsOpenPortE){if(parseInt(c.vsOpenPortS)<=parseInt(a.vsOpenPortS)&&parseInt(c.vsOpenPortE)>=parseInt(a.vsOpenPortS)&&(0==a.vsPtc||0==c.vsPtc||a.vsPtc==c.vsPtc))return EPORTRESERVED}else if(!(parseInt(c.vsOpenPortE)<
parseInt(a.vsOpenPortS)||parseInt(c.vsOpenPortS)>parseInt(a.vsOpenPortE)||0!=a.vsPtc&&0!=c.vsPtc&&a.vsPtc!=c.vsPtc))return EPORTRESERVED;return 0==c.vsLclPortS&&0==c.vsLclPortE?ENONE:0==c.vsLclPortS.length||c.vsLclPortS==c.vsLclPortE||c.vsLclPortS==c.vsOpenPortS&&c.vsLclPortE==c.vsOpenPortE?ENONE:EINVPORT}function w(c,b,a,e){function k(a){m(a[ERR_CODE])?(e(!0),showToast(label.saveSuccess),p()):e(!1)}if(!1==m(v(b,a)))return e(!1);var f=0;0==b.vsLclPortS.length||0==b.vsLclPortS&&0==b.vsLclPortE?(b.vsLclPortS=
b.vsOpenPortS,b.vsLclPortE=b.vsOpenPortE):b.vsLclPortS==b.vsLclPortE&&(f=b.vsLclPortS);a={};var g={},d={};a[uciFirewall.fileName]=g;if("add"==c){var h=calcNextIndex(l);g[KEY_TABLE]=uciFirewall.secType.fwRedirect;g[KEY_NAME]=g[KEY_TABLE]+"_"+h;g[KEY_PARA]=d}else g[b[SEC_NAME]]=d;g=b.vsLclIp;d[uciFirewall.optName.proto]=[uciFirewall.optValue.proto.all,uciFirewall.optValue.proto.tcp,uciFirewall.optValue.proto.udp][b.vsPtc];d[uciFirewall.optName.srcDportStart]=b.vsOpenPortS;d[uciFirewall.optName.srcDportEnd]=
b.vsOpenPortE;d[uciFirewall.optName.destPort]=f;f=checkIPv6(g,{allow_localSole:!0});if(f==ENONE)d[uciFirewall.optName.destIP6]=g,d[uciFirewall.optName.destIP]="";else if(f==EIPV6INVIPFMT)d[uciFirewall.optName.destIP6]="::",d[uciFirewall.optName.destIP]=hideLeadingZeros(g);else{m(f);return}d.wan_port=b.wanPort||0;"add"==c?$.add(a,k):$.modify(a,k)}function x(c,b){var a={},e={},d=[];a[uciFirewall.fileName]=e;e[KEY_NAME]=d;var e=c.split("-"),f;for(f in e)e.hasOwnProperty(f)&&(d[d.length]=l[e[f]][SEC_NAME]);
$.del(a,function(a){a=m(a[ERR_CODE]);b(a);a&&(showToast(label.deleteSuccess),p())})}function p(){var c={},b={};c[uciFirewall.fileName]=b;b[KEY_TABLE]=uciFirewall.secType.fwRedirect;slp.gSysModeSupport&&(c.system={name:"sys_mode"});slp.gMulWanSupport&&(c.port_manage={table:"mwan"});$.query(c,y)}function y(c){var b=c[uciFirewall.fileName][uciFirewall.secType.fwRedirect];if(slp.gMulWanSupport)for(var a=formatTableData(c.port_manage.mwan),e=0;2>e;e++)if(1==a[e].enable){n=!0;break}slp.gSysModeSupport&&
(q=c.system.sys_mode.mode,q!=s&&(t=!0,$(".relayErrorTip").show(),q==z?$("#relayTipText").text("上网方式为AP（有线中继）时，无法使用虚拟服务器功能。"):$("#relayTipText").text("上网方式为桥接（无线中继）时，无法使用虚拟服务器功能。")));null==h&&(c=[{field:label.commonServer,width:"0.21"},{field:label.extPort,width:"0.18"},{field:label.intPort,width:"0.18"},{field:label.ipAddr,width:"0.24"},{field:label.ptc,width:"0.19"}],a=[{name:"server",type:"select",options:d,func:r,maxLength:8,defaultValue:-1,blankStr:label.pSelect},{name:"vsOpenPortS vsOpenPortE",
type:"ports",maxLength:11,isAllowBlank:!1},{name:"vsLclPortS vsLclPortE",type:"ports",maxLength:11},{name:"vsLclIp",type:slp.gIpv6HostCtrlSupport?"ipv4OrIpv6":"ip",isAllowBlank:!1},{name:"vsPtc",type:"select",options:u,maxSelSize:6}],n&&(c=[{field:label.commonServer,width:"0.18"},{field:label.extPort,width:"0.15"},{field:label.activePort,width:"0.20"},{field:label.intPort,width:"0.15"},{field:label.ipAddr,width:"0.21"},{field:label.ptc,width:"0.16"}],a=[{name:"server",type:"select",options:d,func:r,
maxLength:8,defaultValue:-1,blankStr:label.pSelect},{name:"vsOpenPortS vsOpenPortE",type:"ports",maxLength:11,isAllowBlank:!1},{name:"wanPort",type:"select",options:A,maxLength:7},{name:"vsLclPortS vsLclPortE",type:"ports",maxLength:11},{name:"vsLclIp",type:slp.gIpv6HostCtrlSupport?"ipv4OrIpv6":"ip",isAllowBlank:!1},{name:"vsPtc",type:"select",options:u,maxSelSize:6}]),h=new Table({targetId:"virtualServerTable",head:c,column:a,clickList:{click_save:{func:w,asyn:!0},click_del_item:{func:x,asyn:!0}},
max:VIRTUAL_SERVER_RULE_MAX,disableState:t}));b=formatTableData(b);c=[];for(var k in b)if(b.hasOwnProperty(k)){a=b[k];c.push(a);a.vsOpenPortS=a[uciFirewall.optName.srcDportStart];a.vsOpenPortE=a[uciFirewall.optName.srcDportEnd];n&&(a.wanPort=a.wan_port?a.wan_port:0);e=a[uciFirewall.optName.destPort];0==e?(a.vsLclPortS=a.vsOpenPortS,a.vsLclPortE=a.vsOpenPortE):(a.vsLclPortS=e,a.vsLclPortE=e);a.vsLclIp=a[uciFirewall.optName.destIP]?a[uciFirewall.optName.destIP]:a[uciFirewall.optName.destIP6];switch(a[uciFirewall.optName.proto]){case uciFirewall.optValue.proto.tcp:a.vsPtc=
1;break;case uciFirewall.optValue.proto.udp:a.vsPtc=2;break;default:a.vsPtc=0}a.server=d[0].value;for(var f in d)if(d.hasOwnProperty(f)&&d[f].value==a.vsOpenPortS&&d[f].protocol==a.vsPtc){a.server=a.vsOpenPortS;break}}l=c;h.setDataSource(l);h.loadData()}var l=[],d=[{str:label.pSelect,value:-1,protocol:0},{str:"DNS",value:53,protocol:0},{str:"Gopher",value:70,protocol:1},{str:"HTTP",value:80,protocol:1},{str:"NNTP",value:119,protocol:1},{str:"POP3",value:110,protocol:1},{str:"PPTP",value:1723,protocol:0},
{str:"SMTP",value:25,protocol:1},{str:"SOCK",value:1080,protocol:0},{str:"Telnet",value:23,protocol:1}],u=[{str:"ALL"},{str:"TCP"},{str:"UDP"}],s=0,z=1,q=s,n=!1,t=!1,A=[{str:label.auto,value:0},{str:"WAN1",value:1},{str:"WAN2",value:2}],h=null;p()})();
</script>