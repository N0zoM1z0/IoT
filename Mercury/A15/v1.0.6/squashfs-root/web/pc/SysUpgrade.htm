

<div class="head">
	<div class="title"><h1>{%menuStr.upgrade%}</h1><i class="helpBtn iconfont icon-help" helpStr="sysUpgradeHelp"></i></div>
	<p class="description">{%titleDescriptionStr.upgradeDescription%}</p>
</div>
<div class="subTitle">
	<h2>{%label.upgradeOnline%}</h2>
</div>
<span class="upgradeDesc">{%label.upgradeOnlineDesc%}</span>
<div id="upgradeOnlineTable">
</div>
<div class="subTitle">
	<h2>{%label.upgradeLocal%}</h2>
</div>
<span class="upgradeDesc">{%label.upgradeLocalDesc%}</span>
<div id="upgradeLocalTable">
</div><script type="text/javascript">(function(){function u(b){var a="";switch(b){case ENONE:return!0;case EFWEXCEPTION:a=errStr.fwException;break;case EFWRSAFAIL:a=errStr.fwRSAError;break;case EFWHWIDNOTMATCH:a=errStr.fwHwIdNotMatch;break;case EFWZONECODENOTMATCH:a=errStr.fwZoneCodeNotMatch;break;case EFWVENDORIDNOTMATCH:a=errStr.fwVendorIdNotMatch;break;case EFWNOTINFLANDBL:a=errStr.fwNotInFLAndBL;break;case EFWNEWEST:a=errStr.fwNewest;break;case EFWNOTSUPPORTED:a=errStr.fwNotSupported;break;case ECHIPID:a=errStr.fwChipIdNotSupport;
break;case EFLASHID:a=errStr.fwFlashIdNotSupported;break;case EMD5:a=errStr.fwMD5Err;break;case EINVFMT:a=errStr.fwFmtErr;break;case EPRODID:a=errStr.fwProdIdNotSupported;break;case ESUBVER:a=errStr.fwSubVerNotSupported;break;case ECOUNTRYID:a=errStr.fwCountryNotSupported;break;case EOEMID:a=errStr.fwOEmIdNotSupported;break;case ELANGID:a=errStr.fwLangNotSupported;break;case EFILETOOBIG:a=errStr.fileSizeErr}alarmDialog.show(a);return!1}function s(b){var a="";switch(parseInt(b)){case ENONE:return!0;
case EINVSENDREQMSGFAILED:a=errStr.invSendReqMsgFailed;break;case ESYSBUSY:case EINVLASTOPTIONISNOTFINISHED:a=errStr.invLastOptionIsNotFinished;break;case ESYSTEM:a=errStr.invRequestFail;break;case ENOMEMORY:a=errStr.invMemoryOut;break;case EINVGETDATAFAILED:a=errStr.invGetDataFailed;break;case EINVPARAMETER:a=errStr.invParameter;break;case EINVMEMORYOUT:case EINVDOWNLOADFWFAILED:case EINVCONNECTTINGCLOUDSERVER:a=errStr.fwDownLoadFailed;break;case EINVUPGRADEFWFAILED:a=errStr.fwUpgradeFailed;break;
case EINVREQUESTTIMEOUT:a=appendErrCode(errStr.invRequestFailTrylater,b);break;case EINVDEVICEIDNOTEXIST:case EINVERRORDEVICEIDFORMATERROR:case EINVILLEGALDEVICE:a=appendErrCode(errStr.cloudDeviceInfoExpt,b);break;default:b=cloudErrHandle(b),a=!1==b.result?b.tip:errStr.invRequestFail}alarmDialog.show(a);return!1}function v(b){b=b.data;var a,d,f=ENONE;if(/(<pre>)?(.+)(<\/pre>)+/.test(b)||/(<pre>)?(.+)/.test(b))a=RegExp.$2;d=JSON.parse(a);f=d[ERR_CODE];f!=ENONE&&loadingDialog.hide();loadingDialog.hide(function(){z(f,
d)})}function p(){upgradeTimeoutTag=!0;clearTimeout(upgradeTimeoutHd);loadingDialog.hide(function(){e.hide(function(){$(e.iframe).off("load");alarmDialog.show(errStr.upGradeFail)})})}function A(b,a){if(!0!=upgradeTimeoutTag)if(clearTimeout(upgradeTimeoutHd),upgradeTimeoutHd=null,b==ENONE){var d=a.wait_time?1E3*parseInt(a.wait_time):SYSUPGRADE_SECONDS;e.hide(function(){loadingDialog.show({title:label.upgradeLocal,content:{primary:label.upgrading,secondary:label.upgradingTips}},function(){lanDetecting(function(){window.location.reload()})},
d,!1,void 0)})}else u(b)}function z(b,a){if(!0!=upgradeTimeoutTag)if(clearTimeout(upgradeTimeoutHd),upgradeTimeoutHd=null,b==ENONE){var d=a.wait_time?1E3*parseInt(a.wait_time):SYSUPGRADE_SECONDS;e.hide(function(){loadingDialog.show({title:label.upgradeLocal,content:{primary:label.upgrading,secondary:label.upgradingExtTips}},function(){loadingDialog.hide(function(){h()})},d,!1,void 0)})}else u(b)}function w(){function b(){h();loadingDialog.hide()}function a(a){switch(a){case uciPlc.optValue.extOlStatus.readyDownload:case uciPlc.optValue.extOlStatus.downloading:!1==
f&&(f=!0,loadingDialog.show({title:label.upgradeOnline,content:{primary:label.upgrading}},void 0,void 0,!1,void 0));$.setTimeout(d,e);break;case uciPlc.optValue.extOlStatus.readyUpg:case uciPlc.optValue.extOlStatus.upgrading:f&&!c?(c=!0,$.setTimeout(b,x)):c||(c=!0,loadingDialog.show({title:label.upgradeOnline,content:{primary:label.upgrading}},b,x,!1,void 0));$.setTimeout(d,e);break;case uciPlc.optValue.extOlStatus.upgSuccess:if(c||f)h(),"showed"==loadingDialog.status&&loadingDialog.hide();break;
case uciPlc.optValue.extOlStatus.timeout:h();"showed"==loadingDialog.status&&loadingDialog.hide();break;case uciPlc.optValue.extOlStatus.fail:(f||c)&&loadingDialog.hide(function(){alarmDialog.show(errStr.fwUpgradeFailed)})}}function d(){$.query({hyfi:{name:"upgrade_ext_status"}},function(c){c[ERR_CODE]==ENONE&&a(c.hyfi.upgrade_ext_status.status)})}var f=!1,c=!1,x=195E3,e=1E3;d()}function B(){k=!0;loadingDialog.show({title:label.upgradeOnline,content:{primary:label.gettingUpgradeInfo}},void 0,void 0,
!0,function(){k=!1});onlineUpgrade(function(){!0==k&&loadingDialog.hide(function(){alarmDialog.show(gOnlineUpgradeNote);gOnlineUpgradeNote=""})},function(b){!0==k&&loadingDialog.hide(function(){b()})})}function C(){k=!0;loadingDialog.show({title:label.upgradeOnline,content:{primary:label.checkingUpgradeVer}},void 0,void 0,!0,function(){k=!1;clearTimeout(t)});l=new Date;n=l.getTime();onlineUpgradeCheck(s,function(b){!0==k&&(l=new Date,m=l.getTime(),2E3>m-n?t=$.setTimeout(function(){loadingDialog.hide(function(){s(b)})},
200-(m-n)):loadingDialog.hide(function(){s(b)}))},function(){!0==k&&(l=new Date,m=l.getTime(),h(),2E3>m-n?t=$.setTimeout(function(){loadingDialog.hide()},2E3-(m-n)):loadingDialog.hide())})}function D(b){function a(){var a={},c={};a[uciPlc.fileName]={};a[uciPlc.fileName][uciPlc.actionName.upgExt]=c;c[uciPlc.optName.mac]=b.mac;$.action(a,function(a){a[ERR_CODE]==ENONE?(y=a.wait_time?1E3*parseInt(a.wait_time):y,$.setTimeout(function(){loadingDialog.hide(function(){w()})},500)):loadingDialog.hide(function(){alarmDialog.show(errStr.invSendReqMsgFailed)})})}
function d(){var b={};b[uciPlc.fileName]={};b[uciPlc.fileName][KEY_NAME]=uciPlc.secName.startGetExtFwVerStat;$.query(b,function(c){c[ERR_CODE]==ENONE?(c=c[uciPlc.fileName][uciPlc.secName.startGetExtFwVerStat][uciPlc.optName.status],"0"==c?$.setTimeout(d,500):"1"==c?a():(h(),loadingDialog.hide())):loadingDialog.hide(function(){alarmDialog.show(errStr.invSendReqMsgFailed)})})}loadingDialog.show({title:label.upgradeOnline,content:{primary:label.gettingUpgradeInfo}},void 0,void 0,!1,void 0);(function(){var a=
{},c={};a[uciPlc.fileName]={};a[uciPlc.fileName][uciPlc.actionName.startGetExtFwVer]=c;c[uciPlc.optName.mac]=b.mac;$.action(a,function(a){a[ERR_CODE]==ENONE?d():loadingDialog.hide(function(){alarmDialog.show(errStr.invSendReqMsgFailed)})})})()}function E(b){function a(){var c={};c[uciPlc.fileName]={};c[uciPlc.fileName][KEY_NAME]=uciPlc.secName.startGetExtFwVerStat;$.query(c,function(c){c[ERR_CODE]==ENONE&&(c=c[uciPlc.fileName][uciPlc.secName.startGetExtFwVerStat][uciPlc.optName.status],"0"==c?$.setTimeout(a,
500):"2"==c?loadingDialog.hide(function(){alarmDialog.show(errStr.invSendReqMsgFailed)}):(h(),loadingDialog.hide()))})}var d={},f={};d[uciPlc.fileName]={};d[uciPlc.fileName][uciPlc.actionName.startGetExtFwVer]=f;f[uciPlc.optName.mac]=b.mac;$.action(d,function(c){c[ERR_CODE]==ENONE?(loadingDialog.show({title:label.upgradeOnline,content:{primary:label.checkingUpgradeVer}},void 0,void 0,!1,void 0),a()):alarmDialog.show(errStr.invSendReqMsgFailed)})}function h(){var b={};b[uciCloudConfig.fileName]={};
b[uciCloudConfig.fileName][KEY_NAME]=[uciCloudConfig.secName.newFirmware,uciCloudConfig.secName.upgradeInfo];b[uciDeviceInfo.fileName]={};b[uciDeviceInfo.fileName][KEY_NAME]=uciDeviceInfo.secName.info;b[uciProto.fileName]={};b[uciProto.fileName][KEY_NAME]=uciProto.secName.dhcp;b[uciPlc.fileName]={};b[uciPlc.fileName][KEY_TABLE]=uciPlc.secType.connectedExt;$.query(b,function(a){if(ENONE==a[ERR_CODE]){var b=a[uciDeviceInfo.fileName][uciDeviceInfo.secName.info],f=void 0==a[uciProto.fileName][uciProto.secName.dhcp][uciProto.optName.hostName]?
label.canNotDetect:a[uciProto.fileName][uciProto.secName.dhcp][uciProto.optName.hostName],c=void 0==b[uciDeviceInfo.optName.swVer]?label.canNotDetect:b[uciDeviceInfo.optName.swVer],e=a[uciCloudConfig.fileName][uciCloudConfig.secName.newFirmware][uciCloudConfig.optName.fwNewNotify],e=checkNum(e)&&parseInt(e)||uciCloudConfig.optValue.fwNewFalse,h=a[uciCloudConfig.fileName][uciCloudConfig.secName.upgradeInfo],g={};g.name=f;g.cur_fw_version_full=c;g.cur_fw_version=c.split(" ")[0];g.has_new_fw=e==uciCloudConfig.optValue.fwNewTrue&&
void 0!=h[uciCloudConfig.optName.version];g.hw_version=b[uciDeviceInfo.optName.hwVer];g.newest_fw_version=g.has_new_fw?h[uciCloudConfig.optName.version].split(" ")[0]:c.split(" ")[0];g.is_cap=!0;a=formatTableData(a[uciPlc.fileName][uciPlc.secType.connectedExt]);b=0;for(f=a.length;b<f;b++)c=a[b],c[uciPlc.optName.supportOlUp]!=uciPlc.optValue.supportOlUp.yes?(c.name=c.name||label.oldVersion,c.cur_fw_version=label.canNotDetect,c.newest_fw_version=label.canNotDetect,c.cur_fw_version_full=label.canNotDetect,
c.has_new_fw=null):(c.name=void 0==c.name?label.canNotDetect:c.name,c.cur_fw_version=void 0==c.cur_fw_version?label.canNotDetect:c.cur_fw_version,c.newest_fw_version=void 0==c.newest_fw_version?c.cur_fw_version:c.newest_fw_version,c.cur_fw_version_full=""==c.cur_fw_version?label.canNotDetect:c.cur_fw_version,c.cur_fw_version=""==c.cur_fw_version.split(" ")[0]?label.canNotDetect:c.cur_fw_version.split(" ")[0],c.newest_fw_version=c.newest_fw_version.split(" ")[0]||c.cur_fw_version,c.has_new_fw=c.cur_fw_version==
label.canNotDetect||c.newest_fw_version==label.canNotDetect?!1:c.newest_fw_version!=c.cur_fw_version?!0:!1);g=[g];g=a.concat(g);q.setDataSource(g);q.loadData();r.setDataSource(g);r.loadData()}})}var k=!0,t=null,l,n,m,q,r,y=195E3;window.addEventListener?window.addEventListener("message",v,!1):window.attachEvent("onmessage",v);q=new Table({targetId:"upgradeOnlineTable",head:[{field:label.deviceName,width:"0.34"},{field:label.upCurrSoft,width:"0.33"},{field:label.upNewstSoft,width:"0.33"}],column:[{name:uciPlc.optName.name,
type:"str"},{name:"cur_fw_version",type:"str"},{name:"newest_fw_version",type:"str"}],itemOption:[{icon:"icon-onlineupdate",type:"onlineUpdate",str:btn.upgradeOnline,func:function(b,a){var d=q.data[b];d.is_cap?d.has_new_fw?B():C():d.has_new_fw?D(d):E(d)}}],deletable:!1,editable:!1,addable:!1,hasCheckBox:!1});r=new Table({targetId:"upgradeLocalTable",head:[{field:label.deviceName,width:"0.5"},{field:label.upCurrSoft,width:"0.5"}],column:[{name:uciPlc.optName.name,type:"str"},{name:"cur_fw_version",
type:"str"}],itemOption:[{icon:"icon-localupdate",type:"localUpdate",str:btn.upgradeLocal,func:function(b,a){e.show(r.data[b])}}],deletable:!1,editable:!1,addable:!1,hasCheckBox:!1});var e=new Dialog({title:label.upgradeLocal,content:'<span class="localUpgradeTitle">'+label.plzSelectSoftWareAndUpgrade+'</span><div id="importFile"></div>',size:Dialog.SIZE.SMALL,hasCloseIcon:!0,type:Dialog.TYPE.CUSTOM,bottom:[{type:component.Button.TYPE.SECONDARY,text:btn.cancelTip,id:"localUpgradeCancel",onClick:function(){e.hide()}},
{type:component.Button.TYPE.PRIMARY,text:btn.upgrade,id:"localUpgradeSubmit",onClick:function(){var b={};if(e.importFile.checkFile())if(upgradeTimeoutHd=$.setTimeout(p,4E4),e.currentRouter.isCap)b[uciSystem.fileName]={},b[uciSystem.fileName][uciSystem.actionName.firmUpgrade]={type:"0"},$.action(b,function(a){ENONE==a[ERR_CODE]?(e.importFile.submit($.orgURL(a.url)),upgradeTimeoutTag=!1):p()});else{var a="http://"+e.currentRouter.ip,d="undefined"!=typeof USERNAME_SUPPORT&&USERNAME_SUPPORT?{method:"do",
login:{username:$.usr,password:$.pwd}}:{method:"do",login:{password:$.pwd}},f,c;$.ajax({url:a,data:d,type:"POST",async:!0,postDataType:"json",dataType:"json",utf8Encode:!0,success:function(b){b[ERR_CODE]==ENONE?(c=b.stok,f=a+"/stok="+c+"/ds",d={},d[uciSystem.fileName]={},d[uciSystem.fileName][uciSystem.actionName.firmUpgrade]={type:"0"},d.method="do",$.ajax({url:f,data:d,type:"POST",async:!0,postDataType:"json",dataType:"json",utf8Encode:!0,success:function(b){b[ERR_CODE]==ENONE?(e.importFile.submit(a+
"/stok="+c+b.url,!0),upgradeTimeoutTag=!1):p()},error:function(){loadingDialog.hide(function(){alarmDialog.show(errStr.invSendReqMsgFailed);clearTimeout(upgradeTimeoutHd)})}})):p()},error:function(){loadingDialog.hide(function(){alarmDialog.show(errStr.invSendReqMsgFailed);clearTimeout(upgradeTimeoutHd)})}})}}}],renderCallBack:function(){this.importFile=new UpFile({targetId:"importFile",upLoadCallback:A,loadStr:{title:label.upgradeLocal,content:label.fwUploadTip}})}});e.currentRouter={isCap:!1,ip:""};
e.show=function(b){this.currentRouter.isCap=b.is_cap?!0:!1;this.currentRouter.ip=b.ip?b.ip:"";Dialog.prototype.show.call(this)};h();w()})();
</script><style type="text/css">ul.inputCMPT li.input span.desc{font-size:13px;line-height:32px;color:#333}ul.inputCMPT li.input span.desc.upNew{color:#24b353}ul.cloudUpgrade label.outerLbl{vertical-align:top}span.localUpgradeTitle{line-height:20px;font-size:13px;color:#333}#importFile{margin-top:16px}span.upgradeDesc{display:block;margin-bottom:8px;color:#666;height:20px;line-height:20px;font-size:13px}</style>